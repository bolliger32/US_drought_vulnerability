### Model Simulations ####
set.seed(5)
numNum=rnorm(5000, 2, 5)
hist(numNum)
randomPerturbUp=sample(1:5000,100,replace=F)
randomPerturbDown=sample(1:5000[-c(randomPerturbUp)],100,replace=F)
numNum[randomPerturbUp]=30
numNum[randomPerturbDown]=-30
numDenom=2

denomNum=rt(5000,3,10)
hist(numNum)
randomPerturbUp2=sample(1:5000,100,replace=F)
randomPerturbDown2=sample(1:5000[-c(randomPerturbUp2)],100,replace=F)
denomNum[randomPerturbUp2]=50
denomNum[randomPerturbDown2]=-50
denomDenom=3

#### Ratios ####

## create ratios 
numeratorRatio=numNum/numDenom
denominatorRatio=denomNum/denomDenom

## transformed ratios
transformNumeratorRatio=numeratorRatio-1
transformDenominatorRatio=denominatorRatio-1

## ratio of ratios
fullRatio=numeratorRatio/denominatorRatio
transformFullRatio=transformNumeratorRatio/transformDenominatorRatio


hist(fullRatio)
hist(transformFullRatio)
mean(fullRatio) ## 0.269
mean(transformFullRatio) ## 0.002

# fake counties
county=rep(1:1000,5)
county=as.factor(county)

#### Models #### 

model1=lm(fullRatio~I(county))
summary(model1)
transformModel1=lm(transformFullRatio~I(county))
summary(transformModel1)

## multiple testing issue, Bonferroni too conservative, see below for an alternative
which(summary(model1)$coeff[,4]<0.01/1000)
top100=order(summary(model1)$coeff[,4])[1:100]


## not really picking out the perturbation places but this is probably just because of 
## the way I simulated data
length(intersect(randomPerturbUp,county[top100])) ## 8
length(intersect(randomPerturbDown,county[top100])) ## 9
length(intersect(randomPerturbDown2,county[top100])) ## 3
length(intersect(randomPerturbUp2,county[top100])) ## 3

which(summary(transformModel1)$coeff[,4]<0.01/1000)

intersect(c(randomPerturbUp,randomPerturbDown,randomPerturbUp2,randomPerturbDown2), unname(which(summary(transformModel1)$coeff[,4]<0.01/1000))) # 691
transformTop100=order(summary(transformModel1)$coeff[,4])[1:100]

## a little bit better at picking things out
length(intersect(randomPerturbUp,county[transformTop100])) ## 4
length(intersect(randomPerturbDown,county[transformTop100])) ## 11
length(intersect(randomPerturbDown2,county[transformTop100])) ## 3
length(intersect(randomPerturbUp2,county[transformTop100])) ## 3

length(intersect(transformTop100, top100)) ## 83

## same significant counties?
## pick out "right" counties?

## mean per "county"

data=as.data.frame(cbind(fullRatio,transformFullRatio,county))

require(dplyr)

countyLevel <- group_by(data, county)
countyLevel   <- summarise(countyLevel, meanVal = mean(fullRatio),meanValT=mean(transformFullRatio))
head(countyLevel)

## definitely dampening going on
sum(abs(countyLevel$meanVal)>abs(countyLevel$meanValT))


par(mfrow=c(1,2))
hist(countyLevel$meanVal)
abline(v=1,col="red")
hist(countyLevel$meanValT)
abline(v=1,col="red")

## non transformed pulling towards 1



### getting ready for next stage: pulling out the betas #### 

betas=coefficients(model1)
betasTransform=coefficients(transformModel1)

##### stage two outline ####

## beta is one county
## covariate is at county level

covariate1=rnorm(length(betas),5,15)
covariate2=rnorm(length(betas),15,1)

secondStageModel=lm(betas~covariate1+covariate2)
summary(secondStageModel)
## or to simplify matters and avoid model selection
cor(covariate1, betas)
cor(covariate2, betas)

secondStageModelTransform=lm(betasTransform~covariate1+covariate2)
summary(secondStageModel)
## or to simplify matters and avoid model selection
cor(covariate1, betasTransform)
cor(covariate2, betasTransform)


##### Time Series Simulations ####
ts.sim2=arima.sim(list(ar=.5), n = 5000)
ts.sim <- arima.sim(list(order = c(1,1,0), ar = 0.7), n = 5000)
detrended=detrend(as.numeric(ts.sim), tt = 'linear')

plot(ts.sim)
plot(ts.sim2)
mean(ts.sim2)
require(pracma)
plot(detrended)
mean(detrended)

#### Time Series Ratios ####

detrended=detrended+2
numNum2=ts.sim2+2
numDenom2=2
denomNum2=detrended[1:5000]
denomDenom2=2


numeratorRatio2=numNum2/numDenom2
denominatorRatio2=denomNum2/denomDenom2
transformNumeratorRatio2=numeratorRatio2-1
transformDenominatorRatio2=denominatorRatio2-1


fullRatio2=numeratorRatio2/denominatorRatio2
transformFullRatio2=transformNumeratorRatio2/transformDenominatorRatio2


#### Time Series Models ####

model1=lm(fullRatio2~I(county))
summary(model1)
transformModel1=lm(transformFullRatio2~I(county))
summary(transformModel1)

which(summary(model1)$coeff[,4]<0.01/1000)
top100=order(summary(model1)$coeff[,4])[1:100]

require(dplyr)
data=as.data.frame(cbind(fullRatio2,transformFullRatio2,county))

countyLevel <- group_by(data, county)
countyLevel   <- summarise(countyLevel, meanVal = mean(fullRatio),meanValT=mean(transformFullRatio))
head(countyLevel)

## definitely dampening going on
sum(abs(countyLevel$meanVal)>abs(countyLevel$meanValT))


par(mfrow=c(1,2))
hist(countyLevel$meanVal)
abline(v=1,col="red")
hist(countyLevel$meanValT)
abline(v=1,col="red")


###### Benjamni Hochberg FDR (alternative for multiple testing) ####
## https://en.wikipedia.org/wiki/False_discovery_rate
y=unname(abs(betas[order(abs(betas))]))
summary(y)
x=seq(0,1,length=length(betas))

plot(x,y)
q=.05 
## false discovery rate, we are willing to say that this percentage of our "significant" findings
## are spurious
lines(c(0,1),c(0,q))
plot(x,y,ylim=c(0,.1))
lines(c(0,1),c(0,q))

## start from right to left, find first point where it crosses the line, those to the left
## we consider "significant"

## hard to see in this example since no points are truly significant

y=unname(abs(betasTransform[order(abs(betasTransform))]))
summary(y)
x=seq(0,1,length=length(betasTransform))

plot(x,y)
q=.05 
lines(c(0,1),c(0,q))
plot(x,y,ylim=c(0,.1))
lines(c(0,1),c(0,q))