library(shiny)
library(maps)
library(RColorBrewer)
library(sp)
library(SDMTools)
library(maptools)

latlong2county <- function(pointsDF) {
  # Prepare SpatialPolygons object with one SpatialPolygon
  # per county
  counties <- map('county', fill=TRUE, col="transparent", plot=FALSE)
  IDs <- sapply(strsplit(counties$names, ":"), function(x) x[1])
  counties_sp <- map2SpatialPolygons(counties, IDs=IDs,
                                     proj4string=CRS("+proj=longlat"))
  
  
  pointsSP <- SpatialPoints(pointsDF, 
                            proj4string=CRS("+proj=longlat"))
  
  # Use 'over' to get _indices_ of the Polygons object containing each point 
  indices <- over(pointsSP, counties_sp)
  
  # Return the county names of the Polygons object containing each point
  countyNames <- sapply(counties_sp@polygons, function(x) x@ID)
  countyNames[indices]
}

# Define server logic for random distribution application
shinyServer(function(input, output) {
  
  
  
  
  
  # Generate a plot of the data. Also uses the inputs to build
  # the plot label. Note that the dependencies on both the inputs
  # and the data reactive expression are both tracked, and
  # all expressions are called in the sequence implied by the
  # dependency graph
  output$plot <- renderPlot({

    year=input$y ## use to subset data
    index=input$indic ## use to subset data
    
    mypalette<-c(brewer.pal(9,"OrRd"),"black")
    
    randomCol=mypalette[round(runif(length(map('county', plot=FALSE)$names),1,10))] 
    ## replace with color coded according to ratio of ratios
    
    map('county', fill= TRUE, col =randomCol,mar=c(0,0,0,0))
    legend.gradient(cbind(x=c(-117,-115,-115,-117),y=c(30+.2,30+.2,25+.2,25+.2)), 
                    cols = c(brewer.pal(9, "OrRd"),"black"), title="", limits = "",cex=.75)
    
var1.pred=runif(3085,1,10) ## replace with ratio of ratios
 
    text(-113,29.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[11],2),cex=.75)
    text(-113,29.25+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[10],2),cex=.75)
    text(-113,28.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[9],2),cex=.75)
    text(-113,28.25+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[8],2),cex=.75)
    text(-113,27.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[7],2),cex=.75)
    text(-113,27.25+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[6],2),cex=.75)
    text(-113,26.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[5],2),cex=.75)
    text(-113,26.25+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[4],2),cex=.75)
    text(-113,25.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[3],2),cex=.75)
    text(-113,25.25+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[2],2),cex=.75)
    text(-113,24.75+.1+.2,round(quantile(var1.pred,seq(0,1,by=.1))[1],2),cex=.75)
    
    
  })
  
  # Generate a summary of the data
  output$summary  <- renderPlot({
    st=input$state
    
    year=input$y ## use to subset data
    index=input$indic ## use to subset data
    
    mypalette<-c(brewer.pal(9,"OrRd"),"black")
    randomCol=mypalette[round(runif(length(map('county',st, plot=FALSE)$names),1,10))] 
    ## replace with color coded according to ratio of ratios
    
    var1.pred=runif(3085,1,10) ## replace with ratio of ratios
    par(mfrow=c(1,2))
    map("county",st,col=randomCol,fill=T)
    legend("bottomleft", # position
           legend = quantile(var1.pred,seq(0,1,by=.1)), 
           #title = "Percent",
           fill = mypalette,
           cex = 0.56,
           bty = "n")
    long=as.numeric(input$plot_click$x) ## need to fix: when you click, colors change
    lat=as.numeric(input$plot_click$y)
    print(paste(long,lat,sep=","))
    # randomVals <- eventReactive(input$go, { 
    #   ## need to fix: want to print this once county is calculated
    #   ## not getting to this even when clicking go
    #   
    #   countyName=latlong2county(cbind(long,lat))
    #   print(countyName)
    #   
    #   plot(seq(2000,2014,by=1),runif(15,0,1),xlab="Year",type="l")
    # })
    # 
    # par(mfrow=c(1,1))
    
  })
  
  # output$summary2 <- renderPlot({
  #   getCounty()
  # })
  # 
  # getCounty <- eventReactive(input$go, { 
  #   ## need to fix: want to print this once county is calculated
  #   ## not getting to this even when clicking go
  #   
  #  # countyName=latlong2county(cbind(long,lat))
  # #  print(countyName)
  #   print(long)
  #   print(lat)
  #   f(long,lat)
  #   plot(seq(2000,2014,by=1),runif(15,0,1),xlab="Year")
  #   par(mfrow=c(1,1))
  # })
  

  # 
  # f<-function(long,lat){
  #   countyName=latlong2county(cbind(long,lat))
  #   print(countyName)
  # }

  ##http://stackoverflow.com/questions/28023342/interactive-plotting-in-shiny-using-mouse-clicks
  
  # Generate an HTML table view of the data
  output$table <- renderTable({
    data.frame(x=data())
  })
  
})