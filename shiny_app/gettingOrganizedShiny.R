combined<-read.csv("data/data_combined.csv")

require(maps)
data(county.fips)
county.fips

lookup<-read.csv("data/county_ID_lookup_table.csv",stringsAsFactors=T)

library(stringr)
#lookup$STATEFP10=str_pad(lookup[,1], 2, pad = "0")

combined$COUNTYFP10=str_pad(combined[,"COUNTYFP10"],3,pad="0")
combined$combinedFIPS=paste(combined$STATEFP10,combined$COUNTYFP10,sep="")
testMerge=merge(combined,county.fips,by.x="combinedFIPS",by.y="fips",all.x=T)
nrow(testMerge)
nrow(combined)
## missing 110, just carry on for now

names(testMerge)
forShiny<-testMerge[,c(4,26,19,7,13,14,15,16,25)]
names(forShiny)
head(forShiny)
names(forShiny)=c("year","county","state","mortalityOld",
                  "mortalityAll","drought3","drought5","drought1","unemployment")
write.csv(forShiny,"shiny_app/forShinyData.csv",row.names=F)


### cleaning up first stage betas for shiny

betas<-read.csv("combined_betas.csv")
View(betas)


lookup$COUNTYFP10=str_pad(lookup[,"COUNTYFP10"],3,pad="0")
lookup$combinedFIPS=paste(lookup$STATEFP10,lookup$COUNTYFP10,sep="")

testMerge=merge(betas,lookup,by.x="countyID",by.y="GISJOIN",all.x=T)
names(testMerge)
testMerge2=merge(testMerge,county.fips,by.x="combinedFIPS",by.y="fips",all.x=T)
nrow(testMerge2)

names(testMerge2)

forShiny2=testMerge2[,c(18,15,4:12)]
names(forShiny2)[1:2]=c("county","state")
names(forShiny2)

write.csv(forShiny2,"shiny_app/forShinyData2.csv",row.names=F)

### stage 2

stage2<-read.csv("code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv")

testMerge=merge(stage2,lookup,by.x="countyID",by.y="GISJOIN",all.x=T)
names(testMerge)

testMerge2=merge(testMerge,county.fips,by.x="combinedFIPS",by.y="fips",all.x=T)
names(testMerge2)

forShiny3=testMerge2[,c(51,48,13:45)]
names(forShiny3)
names(forShiny3)[1:2]=c("county","state")

write.csv(forShiny3,"shiny_app/forShiny3.csv",row.names=F)
