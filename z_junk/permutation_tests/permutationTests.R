## Permutation Tests
## Sara Stoudt
## Date Created: 2016-04-12

## keep predictor variable values fixed, shuffle response
## recompute beta coefficients
## repeat to get distribution of each beta coefficient
## grab quantiles to get confidence intervals

## Question: what is the most "fair" way to shuffle?
## 1.) all responses are up for grabs
## 2.) fix the time frame, resample across locations at the same time step
## 3.) fix the location, resample across time in the same county

## Each approach answers a differently focused question.
## 1.) Is the spatio-temporal structure statistically significant?
## 2.) Is the spatial structure statistically significant?
## 3.) Is the temporal structure statistically significant?

#### Shuffle All ####
wd="~/Desktop/US_drought_vulnerability/data"
setwd(wd)

combined<-read.csv("data_combined.csv")

length(unique(combined$GISJOIN))

names(combined)

y=10

stateID=length(unique(combined$STATEFP10))
states=unique(combined$STATEFP10)

forParallelMod_ABTS_shuffle=function(i,x,y,data){
 #for(i in 1:stateID){ #
   sub=subset(data,STATEFP10==states[i])
  
  if(length(unique(sub$GISJOIN))==1){
  
  #if(i==9){
    mod_ABTS=lm(sub[,"reshuffleY"]~sub[,x]+sub$year) 
    
  }else{
    
    mod_ABTS=lm(sub[,"reshuffleY"]~sub[,x]*as.factor(sub$GISJOIN)+sub$year) 
    ## need to confirm that the "intercept" is the gamma term we want
  }
  # print(i)#
 #}#
  return(mod_ABTS)
}


# should do at least 1000 times, but start small
shuffledCoeff=unlist(lapply(modelABTS,function(x){coefficients(x)}))
length(shuffledCoeff)
ptm <- proc.time()
for(i in 1:10){
combined$reshuffleY=combined[sample(1:nrow(combined),nrow(combined)),y] 

modelABTS=mclapply(cbind(1:stateID),FUN=forParallelMod_ABTS_shuffle,x=13,y=10,data=combined,mc.cores=1)

allCoefficients=unlist(lapply(modelABTS,function(x){coefficients(x)}))
#print(length(allCoefficients))
shuffledCoeff=cbind(shuffledCoeff,allCoefficients)
print(i)
}
proc.time() - ptm ## 10 takes about 25

## get 95% confidence interval for each beta
CI=apply(shuffledCoeff[,-1],1,function(x){quantile(x,c(0.025,0.975),na.rm=T)})

## want the percentile that our "true" betas are within these distributions
percentileBeta<-c()

for(j in 1:nrow(shuffledCoeff)){
  if(sum(is.na(shuffledCoeff[j,-1]))==ncol(shuffledCoeff[,-1])){
    percentileBeta<-c(percentileBeta,NA)
  }else{
  percentile<-ecdf(shuffledCoeff[j,-1])
  percentileBeta<-c(percentileBeta,percentile(shuffledCoeff[j,1]))
  }
  print(j)
} ## gross but stick with for now

hist(percentileBeta)
length(which(percentileBeta<0.05)) ## 600
length(which(percentileBeta<0.01)) ## 600
length(which(percentileBeta<0.001)) ## 600
## looks like we have about 600 that are significant 

#### Shuffle- fixed time ####
require(permute)
shuffledCoeff=unlist(lapply(modelABTS,function(x){coefficients(x)}))
combined$year=as.factor(combined$year)
#combined$GISJOIN=as.factor(combined$GISJOIN)

ptm <- proc.time()
for(i in 1:10){

  CTRL <- how(plots = Plots(strata = combined$year))
  
  combined$reshuffleY=combined[shuffle(nrow(combined),control=CTRL),y] # takes awhile comparitively
  
  modelABTS=mclapply(cbind(1:stateID),FUN=forParallelMod_ABTS_shuffle,x=13,y=10,data=combined,mc.cores=1)
  
  allCoefficients=unlist(lapply(modelABTS,function(x){coefficients(x)}))
  
  shuffledCoeff=cbind(shuffledCoeff,allCoefficients)
  print(i)
}
proc.time() - ptm ## 27 seconds for 10

## get 95% confidence interval for each beta
CI=apply(shuffledCoeff[,-1],1,function(x){quantile(x,c(0.025,0.975),na.rm=T)})

## want the percentile that our "true" betas are within these distributions
percentileBeta<-c()

for(j in 1:nrow(shuffledCoeff)){
  if(sum(is.na(shuffledCoeff[j,-1]))==ncol(shuffledCoeff[,-1])){
    percentileBeta<-c(percentileBeta,NA)
  }else{
    percentile<-ecdf(shuffledCoeff[j,-1])
    percentileBeta<-c(percentileBeta,percentile(shuffledCoeff[j,1]))
  }
  print(j)
} ## gross but stick with for now

hist(percentileBeta)
length(which(percentileBeta<0.05)) ## 1095
length(which(percentileBeta<0.01)) ## 1095
length(which(percentileBeta<0.001)) ## 1095
## looks like we have about 1095 that are significant 

#### Shuffle- fixed county ####
require(permute)
shuffledCoeff=unlist(lapply(modelABTS,function(x){coefficients(x)}))
combined$year=as.factor(combined$year)
combined$GISJOIN=as.factor(combined$GISJOIN)

ptm <- proc.time()
for(i in 1:10){
  
  CTRL <- how(plots = Plots(strata = combined$GISJOIN))
  
  combined$reshuffleY=combined[shuffle(nrow(combined),control=CTRL),y] # takes awhile comparitively
  
  modelABTS=mclapply(cbind(1:stateID),FUN=forParallelMod_ABTS_shuffle,x=13,y=10,data=combined,mc.cores=1)
  
  allCoefficients=unlist(lapply(modelABTS,function(x){coefficients(x)}))
  
  shuffledCoeff=cbind(shuffledCoeff,allCoefficients)
  print(i)
}
proc.time() - ptm ## 133.125 seconds for 10

## get 95% confidence interval for each beta
CI=apply(shuffledCoeff[,-1],1,function(x){quantile(x,c(0.025,0.975),na.rm=T)})

## want the percentile that our "true" betas are within these distributions
percentileBeta<-c()

for(j in 1:nrow(shuffledCoeff)){
  if(sum(is.na(shuffledCoeff[j,-1]))==ncol(shuffledCoeff[,-1])){
    percentileBeta<-c(percentileBeta,NA)
  }else{
    percentile<-ecdf(shuffledCoeff[j,-1])
    percentileBeta<-c(percentileBeta,percentile(shuffledCoeff[j,1]))
  }
  print(j)
} ## gross but stick with for now

hist(percentileBeta)
length(which(percentileBeta<0.05)) ## 3098
length(which(percentileBeta<0.01)) ## 3098
length(which(percentileBeta<0.001)) ## 3098
## looks like we have about 3098 that are significant 



