## american community survey data download
## DBR & HAL
## 2016-04-07

wd="~/Desktop/drought_project/data" ## replace with your own path name
setwd(wd)

require(xlsx)
require(maptools)
require(downloader)

##download csv of state abbreviations if not downloaded yet
if (file.exists("state_lookup_table.csv")==F){ 
  download("http://www.fonz.net/blog/wp-content/uploads/2008/04/states.csv","state_lookup_table.csv", mode="wb")
}

state = read.csv("state_lookup_table.csv",1,stringsAsFactors=FALSE) 


# download data -----------------------------------------------------------
##if data haven't been downloaded yet, download it
#NOTE: data size is ~33 gb for 15 years of data for 50 states

if (dir.exists("acs")==F) {
  dir.create("acs")
}

setwd("acs")

if (dir.exists("acs_raw")==F | length(list.files('acs_raw'))!=50) {   
  #create folder for raw data working directory
  unlink("acs_raw", recursive=T)
  #dir.create("acs_raw")
  #setwd("acs_raw")
  
  ##download and extract zip files, clean files and process into 1 csv for each state 
  # all raw data and metadata available at: http://www2.census.gov/programs-surveys/acs/data/pums/2011/1-Year/
  
  #set whether to use household or person-level data
  # p - person-level data
  # h - household-level data
  data_level = "p" 
  
  #date range = 2000:2014
  
  #for (row in 1:length(state$Abbreviation)) {  #download all data
    
  for (row in 1:3) {  #download sample data for testing code
    ST = tolower(state$Abbreviation[row])
    #ST is the current state abbreviation
    
    #two loops since url naming structure differs form years 2000-2006, and 2007-present
    for (year in 2000:2006){
      
      url = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/", toString(year),"/csv_"
                   ,data_level,ST,".zip") 
      
      file_name = paste0(ST,"_",toString(year))
      download(url,file_name, mode="wb")
      
      #unzip only csv's into 1 directory
      unzip (file_name, exdir = "acs_raw")
      
      #**CLEAN - remove extraneous columns to reduce file size**
      
    }
    
    for (year in 2007:2014){
      
      url = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/",toString(year),
                   "/1-Year/csv_",data_level,ST,".zip") 
      
      file_name = paste0(ST,"_",toString(year))
      download(url,file_name, mode="wb")
      
      #unzip only csv's directly to acs_raw directory
      unzip (file_name,  exdir = "acs_raw")
      
      #**CLEAN- remove extraneous columns to reduce file size**
      
    }
    
    ##PROCESS DATA HERE INTO 1 TIDY CSV FOR EACH STATE WITH A COLUMN FOR PUMA, YEAR, AND EACH
    ##VARIABLE OF INTEREST
    
  } 
  
  #clean: delete original zip files
  unlink("*.zip")
  
  #CLEAN: delete original csv files
  
}