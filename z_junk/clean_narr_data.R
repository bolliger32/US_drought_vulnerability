#  Description:  This file produces one cleaned narr data that is ready to be merged into the master data set.

library(ncdf4)
library(chron)
library(lattice)

setwd("/Users/katepennington/Dropbox/US_Drought_Vulnerability/US_Drought_Vulnerability/data/narr") # Note: Change the pathname before running code.

# Setup: This setup allows the same code to be used for multiple .nc datasets after an easy redefinition of the filename and varname.

ncname <- "narr_raw/narr_precip"  
ncfname <- paste(ncname,".nc", sep="")
dname <- "apcp"  

# open the netCDF file
ncin <- nc_open(ncfname)
  print(ncin) # Read the data description

# TIME
  t <- ncvar_get(ncin,"time")
  t
  tunits <- ncatt_get(ncin,"time","units") #"hours since 1800-1-1 00:00:0.0"
  nt <- dim(t)
  
  date <- as.Date(t/24, origin = "1800-01-01") # Convert to human-readable date
  
#  Read out the longitude and latitude
lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon)
head(lon)

lat <- ncvar_get(ncin,"lat")
nlat <- dim(lat)
head(lat)

print(c(nlon,nlat))


pcp_array <- ncvar_get(ncin, dname)  # This line needs manual changing to be used with a new data set
dLname <- ncatt_get(ncin,dname,"long_name")
pcpUnits <- ncatt_get(ncin,dname,"units") # This line needs manual changing to be used with a new data set
fillvalue <- ncatt_get(ncin,dname,"_FillValue")
dim(pcp_array)

pcp_array[pcp_array==fillvalue$value] <- NA # Convert missing vals to NA
length(na.omit(as.vector(pcp_array[,,1]))) # Total number of non-missing grid cells

# get the global attributes
title <- ncatt_get(ncin,0,"title")
institution <- ncatt_get(ncin,0,"institution")
datasource <- ncatt_get(ncin,0,"source")
references <- ncatt_get(ncin,0,"references")
history <- ncatt_get(ncin,0,"history")
Conventions <- ncatt_get(ncin,0,"Conventions")

nc_close(ncin) # Close the netCDF
ls() # Doublecheck that all the right stuff is in the workspace

# Save it to a .rdata file

outworkspace="netCDFpcp.RData"
save.image(file=outworkspace)

precip <- load("netCDFpcp.RData")

# ________________________
#2. TEMP

ncname <- "narr_raw/narr_temp"  
ncfname <- paste(ncname,".nc", sep="")
dname <- "air"  

# open the netCDF file
ncin <- nc_open(ncfname)
print(ncin) # Read the data description

#  Read out the longitude and latitude
lon <- ncvar_get(ncin,"lon")
nlon <- dim(lon)
head(lon)

lat <- ncvar_get(ncin,"lat")
nlat <- dim(lat)
head(lat)

print(c(nlon,nlat))

# Read out the time var, noting the units
t <- ncvar_get(ncin,"time")
t

tunits <- ncatt_get(ncin,"time","units")
nt <- dim(t)
nt
tunits$hasatt # logical var
tunits$value # "hours since 1800-1-1 00:00:0.0" 

date <- as.Date(t/24, origin = "1800-01-01") # Convert to human-readable date

tmp_array <- ncvar_get(ncin, dname)  # This line needs manual changing to be used with a new data set
dLname <- ncatt_get(ncin,dname,"long_name")
tmpUnits <- ncatt_get(ncin,dname,"units") # This line needs manual changing to be used with a new data set
fillvalue <- ncatt_get(ncin,dname,"_FillValue")
dim(tmp_array)


# get the global attributes

title <- ncatt_get(ncin,0,"title")
institution <- ncatt_get(ncin,0,"institution")
datasource <- ncatt_get(ncin,0,"source")
references <- ncatt_get(ncin,0,"references")
history <- ncatt_get(ncin,0,"history")
Conventions <- ncatt_get(ncin,0,"Conventions")

nc_close(ncin) # Close the netCDF
ls() # Doublecheck that all the right stuff is in the workspace
rm(pcp_array,pcpUnits)

# Save it to a .rdata file
outworkspace="netCDFtmp.RData"  # Change manually
save.image(file=outworkspace)
