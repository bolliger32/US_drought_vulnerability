## homelessness data CoC combine
## DBR & SAS
## 2016-03-30

wd="~/Desktop/drought_project/data/homeless" ## replace with your own path name
setwd(wd)

require(xlsx)
require(maptools)
require(downloader)

# coc = continuum of care, geographic area for homeless data

##Import point in time homeless data
byCoC=read.xlsx("PIT_Counts.xlsx",1,stringsAsFactors=FALSE)

##Combine 2014 CoC Shapefiles
cocs_dir = "~/desktop/drought_project/data/homeless/raw" #replace with your own path name 
setwd(cocs_dir)
number_CoCs = length(byCoC$"CoC.Number")-2

#all_cocs2@data$TotalHomeless15=5 ## code to add a new column to the data held within a shapefile
## making one giant shape file from each CoC
setwd(paste(wd,"raw",sep="/"))
all_state_folders = list.files()
orderedState=state[order(state[,2]),]

## start it off row=1
setwd(cocs_dir)
current_state_folder = all_state_folders[1]
setwd(current_state_folder)
#setwd(paste(current_state_folder,orderedState[1,1],sep="/")) ## added to account for extra nested folder
sub_folders = list.files()

## start if off file=1
if (sub_folders[1] != "metadata") {
  setwd(sub_folders[1])
  shape_file = paste(sub_folders[1],".shp",sep="")
  thisCoC = readShapePoly(shape_file) 
  
  #starts one big shapefile to all CoC shapefile
  all_cocs2 = thisCoC

}

setwd('..') 

#finishes off first state
for (file in 2:length(sub_folders)){
  if (sub_folders[file] != "metadata") {
    setwd(sub_folders[file])
    shape_file = paste(sub_folders[file],".shp",sep="")
    thisCoC = readShapePoly(shape_file) 
    
    all_cocs2=rbind(all_cocs2,thisCoC,makeUniqueIDs = TRUE)  
    setwd('..') 
  }
}
setwd('..') # move to parent directory, folder with full state name and all shapefile folders
#setwd('..')


## did first one manually, now continue with loop
for (row in 2:length(all_state_folders)) {
  # for (row in 2:4) {   #replace above line with this smaller loop for testing code
  setwd(cocs_dir)
  current_state_folder = all_state_folders[row]
  setwd(current_state_folder)
  #setwd(paste(current_state_folder,orderedState[1,1],sep="/")) ## added to account for extra nested folder
  sub_folders = list.files()
  
  for (file in 1:length(sub_folders)){
    if (sub_folders[file] != "metadata") {
      setwd(sub_folders[file])
      shape_file = paste(sub_folders[file],".shp",sep="")
      thisCoC = readShapePoly(shape_file) 
      
      #assigns homeless pop value to ARD col
      #for (i in 1:number_CoCs) {
      # CoC_num = chartr("-","_",byCoC$"CoC.Number"[i])  #makes CoC number in byCoC match number in folder name
      #if (CoC_num == sub_folders[file]) {
      # print(byCoC$"Total.Homeless..2015"[i])
      #thisCoC$ARD = byCoC$"Total.Homeless..2015"[i]
      #}
      #}
      
      #appends shapefile to all CoC shapefile
      all_cocs2 = rbind(all_cocs2,thisCoC,makeUniqueIDs = TRUE)  
      setwd('..')
    }
  }
  setwd('..') # move to parent directory, folder with full state name and all shapefile folders
  setwd('..') ## added to account for extra nested folder
}


##Assign Homeless Pop Value to New Shapefile Column

#MUST CREATE LOOP FOR EACH YEAR
#Create new column for year
all_cocs2@data[["homeless2014"]] = all_cocs2@data$ARD

#assigns 2014 homeless pop value to new column
##ERROR
all_cocs2@data$homeless2014 = byCoC$"Total.Homeless..2015"[unlist(lapply(all_cocs2@data$COCNUM,function(x){which(byCoC$"CoC.Number"[1:number_CoCs]==x)}))]

class(all_cocs2)

#Remove extraneous shapefile attributes
all_cocs2 = all_cocs2[,-(5:10)] #removes extraneous shapefile attributes

#Save Shapefile
library(maptools)
dir.create("processed")
setwd('processed')
writeSpatialShape(all_cocs2, "allCOCs2014_2015homeless") ## save shapefile+data

##Save Backups in Google Drive
save.image("~/Google Drive/methods_brainstorm_stat259/processed_data/2014_coc_shapefile_data.RData")
setwd('~/Google Drive/methods_brainstorm_stat259/processed_data/')
writeSpatialShape(all_cocs2, "allCOCs2014_2015homeless") ## save shapefile+data


#Delete raw data when code completes
setwd(wd)
unlink('raw',recursive=T,)

#Previous code for assigning homeless pop value in case lapply doesnt funciton
# #assigns 2014 homeless pop value to new columns
# for (shp_row in 1:nrow(all_cocs2@data)){
#   for (xls_row in 1:number_CoCs) {
#     CoC_num = chartr("-","_",byCoC$"CoC.Number"[i])  #makes CoC number in byCoC match number in folder name
#     if (all_cocs2@data$COCNUM[shp_row] == byCoC$CoC.Number[xls_row]) {
#       print(byCoC$"Total.Homeless..2015"[xls_row])
#       all_cocs2@data$homeless2014[shp_row] = byCoC$"Total.Homeless..2015"[xls_row]
#     }
#   }
# }