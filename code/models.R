wd="~/Desktop/US_drought_vulnerability/data"
setwd(wd)

combined<-read.csv("data_combined.csv")
nrow(combined)
names(combined)
length(unique(combined$GISJOIN)) ## 3124
length(unique(combined$COUNTY_NAME10)) ## 1819
## why don't these match? ask Yang

require(dplyr)
by_GIS <- group_by(combined, GISJOIN)
num <- summarise(by_GIS,
                   count = n()
                   )
summary(num$count)
which(num$count<11)
num$count[which(num$count<11)]
require(lme4) ## mixed effect modelling
require(car)

#boxplot(combined$drought_3year~combined$COUNTY_NAME10)
#boxplot(combined$drought_3year~combined$STATE_NAME10)

## y_{i,t}=\beta D_{i,t}
mod.1=lm(rate_adj_all_b~drought_3year,data=combined )
summary(mod.1)
betas.1=coefficients(mod.1)

hist(combined$rate_adj_all)
hist(combined$drought_3year)

# testSubLevels=levels(combined$GISJOIN)[1:1000]
# testSub=subset(combined,GISJOIN %in% testSubLevels)
# nrow(testSub)
# ptm <- proc.time()
# mod.2aSMALL=lm(rate_adj_all_b~drought_3year+as.factor(GISJOIN),data=testSub)
# proc.time() - ptm ## 10 seconds for 1000, 81 seconds 2000
# summary(mod.2aSMALL)

ptm <- proc.time()
mod.2a=lm(rate_adj_all_b~drought_3year+as.factor(GISJOIN),data=combined)
proc.time() - ptm  ## about 5 minutes, have to be patient :/
sum(is.na(coefficients(mod.2a))) ##0
summary(mod.2a)

testSubLevels=levels(combined$GISJOIN)[1:2000]
testSub=subset(combined,GISJOIN %in% testSubLevels)
nrow(testSub)
ptm <- proc.time()
mod.2SMALL=lm(rate_adj_all_b~scale(drought_3year,center=T,scale=F)*as.factor(GISJOIN),data=testSub)
proc.time() - ptm ## 40 seconds for 1000, 5 minutes for 2000
summary(mod.2SMALL)
sum(is.na(coefficients(mod.2SMALL))) ## 46, now worrying about multicollinearity?
## centering doesn't fix

## y_{i,t}=\beta_i D_{i,t}+\alpha_i
mod.2=lm(rate_adj_all_b~drought_3year*as.factor(GISJOIN),data=combined)
summary(mod.2)
betas.2=coefficients(mod.2)
betas.2n=names(coefficients(mod.2))
#summary(mod.2)$df
sum(is.na(coefficients(mod.2))) ## NA coefficients due to multicollinearity
betas.2n[is.na(coefficients(mod.2))]


## Subtract the mean method, which is also known as centering the variables. 
## This method removes the multicollinearity produced by interaction and higher-order terms 
## as effectively as the other standardization methods, but it has the added benefit of not 
## changing the interpretation of the coefficients
mod.2b=lm(rate_adj_all_b~scale(drought_3year,center=TRUE,scale=FALSE)*as.factor(COUNTYFP10),
          data=combined)
summary(mod.2b)
betas.2b=coefficients(mod.2b)
betas.2bn=names(coefficients(mod.2b))
#summary(mod.2b)$df
sum(is.na(coefficients(mod.2b))) ## still multicollinearity
betas.2bn[is.na(coefficients(mod.2b))]


## y_{i,t}=\beta_i D_{i,t}+\alpha_i+ \tau_i t
mod.3=lm(rate_adj_all_b~drought_3year*as.factor(COUNTYFP10)+year,data=combined)
summary(mod.3)
betas.3=coefficients(mod.3)
betas.3n=names(coefficients(mod.3))
#summary(mod.3)$df
#Coefficients: (14 not defined because of singularities)
sum(is.na(coefficients(mod.3))) ## NA coefficients due to multicollinearity
betas.3n[is.na(coefficients(mod.3))]

##  y_{i,t}=\beta_i D_{i,t}+\alpha_i+ \tau_i t +\gamma_{s,t}
mod.4=lm(rate_adj_all_b~drought_3year*as.factor(COUNTYFP10)+year+as.factor(STATEFP10),data=combined)
summary(mod.4)
betas.4=coefficients(mod.4)
betas.4n=names(coefficients(mod.4))
sum(is.na(coefficients(mod.4)))
betas.4n[is.na(coefficients(mod.4))]

## what if we do it by state?
mod.5=lm(rate_adj_all_b~drought_3year*as.factor(STATEFP10),data=combined)
summary(mod.5)
betas.5=coefficients(mod.5)
sum(is.na(coefficients(mod.5))) ##0

## add time effect
mod.6=lm(rate_adj_all_b~drought_3year*as.factor(STATEFP10)+year,data=combined)
summary(mod.6)
betas.6=coefficients(mod.6)
sum(is.na(coefficients(mod.6))) ##0



### troublesome counties

problemCounties<-c(20,50,70,100,110,122,130,150,180,188,198,220,270,431)

names(combined)
length(unique(combined$COUNTYFP10))


testM=merge(drought,mortality,by.x=c("GISJOIN","year"),by.y=c("GISJOIN","year"))
nrow(testM)
names(drought)
names(mortality)
