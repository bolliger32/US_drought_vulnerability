## cleaned_combined_second_stage.R
## Filter out outlier first stage beta values
## Inputs: combined_inputs_outputs file
## Outputs: filtered csv file to the combined_inputs folder
## Author: Daniel REjto
## Date: 5/3/16

#clean environment
rm(list=ls())

#import data
unfiltered = read.csv('code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv')

#cleaning function to replace values above 95% percentile and below 5% percentile with NAs
filter_outliers <- function(x){
  quantiles <- quantile( x, c(.05, .95 ),na.rm=T )
  x[ x < quantiles[1]] <- NA
  x[ x > quantiles[2]] <- NA
  x
}

#clean data
filtered = lapply(unfiltered[,3:20],filter_outliers)

#Test results
#summary(unfiltered$coeff_r_24_p_13)
#summary(filtered$coeff_r_24_p_13)

#save results
unfiltered[,3:20] = filtered
unfiltered = unfiltered[,-1]
write.csv(unfiltered,'code/analysis_stage2/combined_inputs/cleaned_combined_stage2.csv')