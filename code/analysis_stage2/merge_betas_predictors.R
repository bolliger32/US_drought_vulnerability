#description: Combines Analysis Stage 1 Coefficients and Explanatory Variables into 1 Data Frame
#inputs: -combined beta csv file from code/analysis_stage2/combined_data
#        -summarized_acs data from data/acs
#       -epa data from data/epa
#       -rural indicator data for counties from data/rural
#outputs: csv of betas from stage 1 and explanatory variables matched to county ID 
#authors: Dan Blaustein Rejto
#start date: 4/18/2016

#clean environment
rm(list=ls())

######Merge in Predictors

###import combined predictor and outcome data
betas = read.csv("analysis_stage2/combined_inputs/combined_betas.csv",header=T,stringsAsFactors=F)

acs = read.csv("../data/acs/summarized_acs.csv")
epa = read.csv("../data/epa/clean_epa.csv",header=T,stringsAsFactors=F)
rural = read.csv('../data/rural/rural.csv',header=T,stringsAsFactors=F)

###Reformat Columns
##reformat epa data
#reformat epa column ids from county=1 to fixed length of 5 with leading 0s and 1 trailing 0
old_county = epa[,2]
new_county = sprintf("%04d0", old_county) #creates list of col values coerced to 5 digit strings

#reformat epa column ids from state = 1 to fixed length of 2 with leading 0s
old_state = epa[,3]
new_state = sprintf("%02d", old_state) #creates list of col values coerced to 2 digit strings

#create epa new column to match GISJOIN format of G0100010
new_col = paste0("G",new_state,new_county)

#add new column to epa dataframe
epa["GISJOIN"] = new_col


##reformat rural data
#function to separate last 3 digits from FIPS code
substrRight <- function(x, n){
  sapply(x, function(xx)
    substr(xx, (nchar(xx)-n+1), nchar(xx))
  )
}

#standardize FIPS column values to 5 digits
rural[,2] = sprintf("%05d", rural[,2]) #creates list of col values coerced to 5 digit strings

#separate county FIPS code
rural[,'county'] = substrRight(rural[,2],3)

#standardize county FIPS code to 4 digits (with prepended 0)
rural[,'county'] = sprintf("%04s",rural[,'county'])

#separate state FIPS code
rural[,'state'] = substr(rural[,2],1,2)

#standardize state FIPS code to 3 digits (with prepended 0)
rural[,'state'] = sprintf("%0s",rural[,'state'])

#create combined new column to match GISJOIN format of G0100010
rural[,'GISJOIN'] = paste0("G",rural[,'state'],rural[,'county'],'0')

#remove extraneous columns
rural = rural[,c(5,8)]

###Merge data
#merge in acs using county id GISJOIN
beta_cty_id = colnames(betas)[2] #sets key to merge files on
acs_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(betas,acs,by.x=beta_cty_id,by.y=acs_cty_id,all=F)

#merge in epa them using county id GISJOIN
cty_id = colnames(stage2_combined)[1] #sets key to merge files on
epa_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(stage2_combined,y = epa[,c("GISJOIN","wUse")],by.x=cty_id,by.y=epa_cty_id,all=F)

#merge in rural using county id GISJOIN
cty_id = colnames(stage2_combined)[1] #sets key to merge files on
rural_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(stage2_combined,rural,by.x=cty_id,by.y=rural_cty_id,all=F)

###Clean
#remove extraneous columns created by merge and additional ACS weighting factors
stage2_combined = subset(stage2_combined, select=-c(X.x,X.y,PWGTP_mean,PWGTP_sd,
                                                    WGTP_mean,WGTP_sd,WATP_WGTP_mean,
                                                    WATP_WGTP_sd,race_black_mean,race_black_sd))

#reformat to put standard errors at end of d.f.
stage2_combined = stage2_combined[,c(1:19,38:ncol(stage2_combined),20:37)]


##save
write.csv(stage2_combined,file="analysis_stage2/combined_inputs/combined_acs_epa_betas.csv")