#description: Combines Analysis Stage 1 Coefficients and Explanatory Variables into 1 Data Frame
#inputs: -combined beta csv file from code/analysis_stage2/combined_data
#        -summarized_acs data from data/acs
#       -epa data
#       -rural indicator data for counties
#outputs: csv of betas from stage 1 and explanatory variables matched to county ID 
#authors: Dan Blaustein Rejto
#start date: 4/18/2016

######Merge in ACS
#import combined data and acs data
betas = read.csv("code/analysis_stage2/combined_inputs/combined_betas.csv",header=T,stringsAsFactors=F)
acs = read.csv("data/acs/summarized_acs.csv")

#merge them using county id GISJOIN
beta_cty_id = colnames(betas)[2] #sets key to merge files on
acs_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(betas,acs,by.x=beta_cty_id,by.y=acs_cty_id)


######Merge in EPA
epa = read.csv("data/epa/clean_epa.csv",header=T,stringsAsFactors=F)

#reformat acs column ids from county=1 to fixed length of 5 with leading 0s and 1 trailing 0
old_county = epa[,2]
new_county = sprintf("%04d0", old_county) #creates list of col values coerced to 5 digit strings

#reformat acs column ids from state = 1 to fixed length of 2 with leading 0s
old_state = epa[,3]
new_state = sprintf("%02d", old_state) #creates list of col values coerced to 2 digit strings

#create combined new column to match GISJOIN format of G0100010
new_col = paste0("G",new_state,new_county)

#add new column to acs dataframe
epa["GISJOIN"] = new_col

#merge them using county id GISJOIN
cty_id = colnames(stage2_combined)[1] #sets key to merge files on
epa_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(stage2_combined,y = epa[,c("GISJOIN","wUse")],by.x=cty_id,by.y=epa_cty_id)


######Merge in Rural
rural = read.csv('data/rural/rural.csv',header=T,stringsAsFactors=F)

#reformat rural column ids 

#function to separate last 3 digits from FIPS code
substrRight <- function(x, n){
  sapply(x, function(xx)
    substr(xx, (nchar(xx)-n+1), nchar(xx))
  )
}

#standardize FIPS column values to 5 digits
rural[,2] = sprintf("%05d", rural[,2]) #creates list of col values coerced to 5 digit strings

#separate county FIPS code
rural[,'county'] = substrRight(rural[,2],3)

#standardize county FIPS code to 4 digits (with prepended 0)
rural[,'county'] = sprintf("%04s",rural[,'county'])

#separate state FIPS code
rural[,'state'] = substr(rural[,2],1,2)

#standardize state FIPS code to 3 digits (with prepended 0)
rural[,'state'] = sprintf("%0s",rural[,'state'])

#create combined new column to match GISJOIN format of G0100010
rural[,'GISJOIN'] = paste0("G",rural[,'state'],rural[,'county'],'0')

#remove extraneous columns
rural = rural[,c(5,8)]

#merge them using county id GISJOIN
cty_id = colnames(stage2_combined)[1] #sets key to merge files on
rural_cty_id = "GISJOIN" #sets key to merge files on
stage2_combined = merge(stage2_combined,rural,by.x=cty_id,by.y=rural_cty_id)


#remove extraneous columns created by merge
stage2_combined = subset(stage2_combined, select=-c(X.x,X.y))

#save
write.csv(stage2_combined,file="code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv")