#description: Regress Stage 1 betas on County-Level Characteristics
#inputs: -combined inputs file from code/analysis_stage2/combined_data
#outputs: -csv of regression coefficients
#authors: Dan Blaustein Rejto
#start date: 4/19/2016

#import data
dat = read.csv("code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv") #update w/ final inputs

#apply regression to each outcome beta column and combination of covariate columns

predictors = as.list((names(dat)[12:43]))
predicted = (names(dat)[3:11])

#create data frame of regression coefficients for each ACS variable
#for each predicted value column, regress that column on the predictor values in columns 12:43
#note: if anyone knows a proper way to do this, please share

getreg <- function(x){
  mod = lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ 
             dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ 
             dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ 
             dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ 
             dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ 
             dat[,41]+ dat[,42],dat)
  #results = paste('results',toString(x),sep="_")
  results = as.data.frame(summary(mod)$coefficients[,c(1,4)])
  results <- cbind(Predictors = rownames(results), results)
  rownames(results) <- NULL
  
  #results[,1] = 'Predictors'
  #row.names(results)[2:29] = names(dat)[12:24,26,27,28:40,41]
  
  results[,'Outcome'] = rep(toString(colnames(dat)[x]),length(rownames(results)))
  #return(all_results = rbind(results,all_results))
  return(results)
  #return(all_results)
}

#initialize dataframe of reuslts
all_results=getreg(3)

#append to dataframe the results of each regression
for (i in 4:11){
  results = getreg(i)
  all_results = rbind(all_results,results,make.row.names=F)
}
  
#save
if (dir.exists("results")==F){
  dir.create("results")
}

write.csv(all_results,file="results/stage2_betas_tidy.csv")



#old attempts at applying regression to 1st stage analyiss columns
#results = lapply(predicted,lm(predicted~dat[predictors],data = dat)) 

#plyrFunc <- function(x){
 # mod <- lm(x~predictors, data = dat)
  #return(summary(mod)$coefficients[-1:-2,1])
#}

#bStats <- ddply(dat, .(a), plyrFunc)


###code that just makes tidy table of point estimates

#my_coefs <- sapply(3:11, function(x) coef(lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat)))
#
#all_coefs <- sapply(3:11, function(x) lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat))
#pvals <- sapply(3:11, function(x) coef(lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat), ))
#
##colnames(my_coefs)[1] = "predictor"
#colnames(my_coefs) = names(dat)[3:11] 
#rownames(my_coefs)[2:32] = names(dat)[12:42]
#
##create tidy data frame version
#tidy_coefs = melt(my_coefs,id.vars = "row.names", measure.vars = 2:length(colnames(my_coefs),variable.names = "coeff1"))
#
#colnames(tidy_coefs) = c('predictors','outcomes','betas')

##save
#write.csv(my_coefs,file="results/stage2_betas_crosstab.csv")
#write.csv(tidy_coefs,file="results/stage2_betas_tidy.csv")
