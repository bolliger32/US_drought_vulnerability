#description: Regress Stage 1 betas on County-Level Characteristics
#inputs: -combined betas and acs/epa file from code/analysis_stage2/combined_data
#outputs: -csv of regression coefficients for model with means and with standard deviations
#authors: Dan Blaustein Rejto
#start date: 4/19/2016

##clean environment
rm(list=ls())

##import data
#non-filtered data
dat = read.csv("code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv")


##add names of beta columns for labelling
beta_labels = c('placeholder','placeholder','rate_all_3yr','rate_all_5yr',
                'rate_all_1yr','unemployment_3yr','unemployment_5yr','unemployment_1yr',
                'corn_3yr','corn_5yr','corn_1yr','soy_3yr','soy_5yr','soy_1yr',
                'wheat_3yr','wheat_5yr','wheat_1yr','rate_65_3yr','rate_65_5yr',
                'rate_65_1yr')

##apply regression to each outcome beta column and combination of covariate columns
#create data frame of regression coefficients for each ACS variable
#regress each predicted value columnon the predictor columns

#regression with only predictor sd's and omitting % black

predictors = colnames(dat)[30:40]

getreg_sd <- function(x){
  mod = lm(dat[,x] ~ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ 
             dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+dat[,40], dat)
  results = as.data.frame(summary(mod)$coefficients[,c(1,2,4)])
  results <- cbind(Predictors = rownames(results), results)
  
  #label columns and rows
  
  rownames(results) <- NULL
  results[,'Outcome'] = rep(toString(names(dat)[x]),length(rownames(results)))
  #results[,'Outcome'] = rep(toString(beta_labels[x]),length(rownames(results)))
  results[,'Predictors'] = c('(Intercept)',predictors)
  
  return(results)
}

#regression with only predictor means and omitting % black
predictors_means = c(colnames(dat)[21:29],names(dat)[39],names(dat)[40])
getreg_onlymeans <- function(x){
  mod = lm(dat[,x] ~ dat[,21]+ dat[,21]+ dat[,22] + dat[,23]+ dat[,24]+ dat[,25]+dat[,26]+ dat[,27]+ 
             dat[,28]+dat[,29] +dat[,39] + dat[,40], dat)
  results = as.data.frame(summary(mod)$coefficients[,c(1,2,4)])
  results <- cbind(Predictors = rownames(results), results)
  
  #rename columns and add outcome column
  rownames(results) <- NULL  
  results[,'Outcome'] = rep(toString(names(dat)[x]),length(rownames(results)))
  #results[,'Outcome'] = rep(toString(beta_labels[x]),length(rownames(results)))
  results[,'Predictors'] = c('(Intercept)',predictors_means)
  return(results)
}

##for 1st regression
#initialize dataframe of results
all_results_sd = getreg_sd(3)
all_results_means = getreg_onlymeans(3)

#append to dataframe the results of each regression

#select columns to use as outcomes in regression
#only selecting the 1st stage betas that used drought 3 yr

coeffs = seq(6,20,3) 

##1st regression
for (i in coeffs){  #should be set to the number of columns beginning with 'coeff'
  results = getreg_sd(i)
  all_results_sd = rbind(all_results_sd,results,make.row.names=F)
}


##2nd regression
for (i in coeffs){  
  results = getreg_onlymeans(i)
  all_results_means = rbind(all_results_means,results,make.row.names=F)
}


#save
if (dir.exists("results")==F){
  dir.create("results")
}

write.csv(all_results_sd,file="results/stage2_results_sd.csv")
write.csv(all_results_means,file="results/stage2_results_means.csv")