#description: Regress Stage 1 betas on County-Level Characteristics
#inputs: -combined inputs file from code/analysis_stage2/combined_data
#outputs: -csv of regression coefficients
#authors: Dan Blaustein Rejto
#start date: 4/19/2016

#import data
dat = read.csv("code/analysis_stage2/combined_inputs/combined_acs_epa_betas.csv") #update w/ final inputs

#add names of beta columns for labelling
beta_labels = c('placeholder','placeholder','rate_all_3yr','rate_all_5yr','rate_all_1yr','unemployment_3yr','unemployment_5yr','unemployment_1yr','corn_3yr','corn_5yr','corn_1yr','soy_3yr','soy_5yr','soy_1yr','wheat_3yr','wheat_5yr','wheat_1yr','rate_65_3yr','rate_65_5yr','rate_65_1yr')

#apply regression to each outcome beta column and combination of covariate columns
#create data frame of regression coefficients for each ACS variable
#regress each predicted value columnon the predictor columns

#includes all predictors including sd's for each
predictors = colnames(dat)[21:47]

getreg <- function(x){
  mod = lm(dat[,x] ~ dat[,21]+ dat[,22]+ 
             dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ 
             dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ 
             dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ 
             dat[,41]+ dat[,42]+ dat[,43] + dat[,44]+ dat[,45]+ dat[,46]+
             dat[,47] , dat)
  results = as.data.frame(summary(mod)$coefficients[,c(1,2,4)])
  results <- cbind(Predictors = rownames(results), results)
  
  #label columns and rows
  rownames(results) <- NULL
  results[,'Outcome'] = rep(toString(beta_labels[x]),length(rownames(results)))
  results[,'Predictors'] = c('(Intercept)',predictors)
  return(results)
}

#regression with only predictor means, 
#omitting WATP (population) due to high collinearity with WGTP(households)
predictors_means = colnames(dat)[22:34]
getreg_onlymeans <- function(x){
  mod = lm(dat[,x] ~ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ 
             dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34], dat)
  results = as.data.frame(summary(mod)$coefficients[,c(1,2,4)])
  results <- cbind(Predictors = rownames(results), results)
  
  #rename columns and add outcome column
  rownames(results) <- NULL  
  results[,'Outcome'] = rep(toString(beta_labels[x]),length(rownames(results)))
  results[,'Predictors'] = c('(Intercept)',predictors_means)
  return(results)
}

##for 1st regression
#initialize dataframe of results
all_results=getreg(3)
all_results_means = getreg_onlymeans(3)

#append to dataframe the results of each regression
##1st regression
for (i in 4:20){  #should be set to the number of columns beginning with 'coeff'
  results = getreg(i)
  all_results = rbind(all_results,results,make.row.names=F)
}

##2nd regression
for (i in 4:20){  #should be set to the number of columns beginning with 'coeff'
  results = getreg_onlymeans(i)
  all_results_means = rbind(all_results_means,results,make.row.names=F)
}


#save
if (dir.exists("results")==F){
  dir.create("results")
}

write.csv(all_results,file="results/stage2_betas_tidy.csv")
write.csv(all_results_means,file="results/stage2_betas_tidy_onlymeans.csv")


#old attempts at applying regression to 1st stage analyiss columns
#results = lapply(predicted,lm(predicted~dat[predictors],data = dat)) 

#plyrFunc <- function(x){
 # mod <- lm(x~predictors, data = dat)
  #return(summary(mod)$coefficients[-1:-2,1])
#}

#bStats <- ddply(dat, .(a), plyrFunc)


###code that just makes tidy table of point estimates

#my_coefs <- sapply(3:11, function(x) coef(lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat)))
#
#all_coefs <- sapply(3:11, function(x) lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat))
#pvals <- sapply(3:11, function(x) coef(lm(dat[,x] ~ dat[,12] + dat[,13]+ dat[,14]+ dat[,15]+ dat[,16]+ dat[,17]+ dat[,18]+ dat[,19]+ dat[,20]+ dat[,21]+ dat[,22]+ dat[,23]+ dat[,24]+ dat[,25]+ dat[,26]+ dat[,27]+ dat[,28]+ dat[,29]+ dat[,30]+ dat[,31]+ dat[,32]+ dat[,33]+ dat[,34]+ dat[,35]+ dat[,36]+ dat[,37]+ dat[,38]+ dat[,39]+ dat[,40]+ dat[,41]+ dat[,42],dat), ))
#
##colnames(my_coefs)[1] = "predictor"
#colnames(my_coefs) = names(dat)[3:11] 
#rownames(my_coefs)[2:32] = names(dat)[12:42]
#
##create tidy data frame version
#tidy_coefs = melt(my_coefs,id.vars = "row.names", measure.vars = 2:length(colnames(my_coefs),variable.names = "coeff1"))
#
#colnames(tidy_coefs) = c('predictors','outcomes','betas')

##save
#write.csv(my_coefs,file="results/stage2_betas_crosstab.csv")
#write.csv(tidy_coefs,file="results/stage2_betas_tidy.csv")
