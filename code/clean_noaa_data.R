#  Description:  This file produces one cleaned NOAA data that is ready to be merged into the master data set.

#  NOTE:  The divisions still need to be matched to the GISJOIN variable we will use to merge all our data.

# Process:

# A. In each data set:
  # 1. Drop years 1895-1999
  # 2. Disaggregate unique ID into state, division, element, and year variables
  # 3. Rename element codes to meaningfully name the variables

# B. Merge all NOAA datasets on state, division, and year

library(readr)
library(dplyr)
library(ggplot2)

setwd("/Users/katepennington/Dropbox/US_Drought_Vulnerability/US_Drought_Vulnerability/data/noaa")

# Read in and clean precip data
precip <- read.table("noaa_raw/noaa_precip.csv",
                 header = FALSE)
precip_IDs <- read.fwf("noaa_raw/noaa_precip.csv", 
         widths = c(2,2,2,4),
         colClasses = "character", 
         col.names = c("state", "div", "var","year"))  # split unique ID into components
precip <- cbind(precip_IDs,precip)
precip <- subset(precip, select=-c(var,V1))  
    # Remove V1 = conglomerated unique ID and 
    # var = element ID

names(precip) <- c("state", "div","year","pcp01","pcp02",
                   "pcp03","pcp04","pcp05","pcp06", "pcp07","pcp08",
                   "pcp09","pcp10","pcp11","pcp12")
precip <- subset(precip, year > 1999)


#  TEMP 

temp <- read.table("noaa_raw/noaa_temp.csv",
                   header = FALSE)
temp_IDs <- read.fwf("noaa_raw/noaa_temp.csv", 
                     widths = c(2,2,2,4),
                     colClasses = "character", 
                     col.names = c("state", "div", "var","year"))  
temp <- cbind(temp_IDs,temp)
temp <- subset(temp, select=-c(var,V1))  
names(temp) <- c("state", "div","year","tmp01","tmp02",
                 "tmp03","tmp04","tmp05","tmp06", "tmp07","tmp08",
                 "tmp09","tmp10","tmp11","tmp12")
temp <- subset(temp, year > 1999)


#  PDSI

pdsi <- read.table("noaa_raw/noaa_pdsi.csv",
                   header = FALSE)
pdsi_IDs <- read.fwf("noaa_raw/noaa_pdsi.csv", 
                     widths = c(2,2,2,4),
                     colClasses = "character", 
                     col.names = c("state", "div", "var","year")) 
pdsi <- cbind(pdsi_IDs,pdsi)
pdsi <- subset(pdsi, select=-c(var,V1))  

names(pdsi) <- c("state", "div","year","pdsi01","pdsi02",
                 "pdsi03","pdsi04","pdsi05","pdsi06", "pdsi07","pdsi08",
                 "pdsi09","pdsi10","pdsi11","pdsi12")
pdsi <- subset(pdsi, year > 1999)


#  PHDI

phdi <- read.table("noaa_raw/noaa_phdi.csv",
                   header = FALSE)
phdi_IDs <- read.fwf("noaa_raw/noaa_phdi.csv", 
                     widths = c(2,2,2,4),
                     colClasses = "character", 
                     col.names = c("state", "div", "var","year")) 
phdi <- cbind(phdi_IDs,phdi)
phdi <- subset(phdi, select=-c(var,V1))

names(phdi) <- c("state", "div","year","phdi01","phdi02",
                 "phdi03","phdi04","phdi05","phdi06", "phdi07","phdi08",
                 "phdi09","phdi10","phdi11","phdi12")
phdi <- subset(phdi, year > 1999)


#  ZNDX

zndx <- read.table("noaa_raw/noaa_zndx.csv",
                   header = FALSE)
zndx_IDs <- read.fwf("noaa_raw/noaa_zndx.csv", 
                     widths = c(2,2,2,4),
                     colClasses = "character", 
                     col.names = c("state", "div", "var","year")) 
zndx <- cbind(zndx_IDs,zndx)
zndx <- subset(zndx, select=-c(var,V1))  

names(zndx) <- c("state", "div","year","zndx01","zndx02",
                 "zndx03","zndx04","zndx05","zndx06", "zndx07","zndx08",
                 "zndx09","zndx10","zndx11","zndx12")
zndx <- subset(zndx, year > 1999)

#  CDD

cdd <- read.table("noaa_raw/noaa_cdd.csv",
                  header = FALSE)
cdd_IDs <- read.fwf("noaa_raw/noaa_cdd.csv", 
                    widths = c(2,2,2,4),
                    colClasses = "character", 
                    col.names = c("state", "div", "var","year")) 
cdd <- cbind(cdd_IDs,cdd)
cdd <- subset(cdd, select=-c(var,V1))

names(cdd) <- c("state", "div","year","cdd01","cdd02",
                "cdd03","cdd04","cdd05","cdd06", "cdd07","cdd08",
                "cdd09","cdd10","cdd11","cdd12")
cdd <- subset(cdd, year > 1999)


# HDD

hdd <- read.table("noaa_raw/noaa_hdd.csv",
                  header = FALSE)
hdd_IDs <- read.fwf("noaa_raw/noaa_hdd.csv", 
                    widths = c(2,2,2,4),
                    colClasses = "character", 
                    col.names = c("state", "div", "var","year")) 
hdd <- cbind(hdd_IDs,hdd)
hdd <- subset(hdd, select=-c(var,V1))  

names(hdd) <- c("state", "div","year","hdd01","hdd02",
                "hdd03","hdd04","hdd05","hdd06", "hdd07","hdd08",
                "hdd09","hdd10","hdd11","hdd12")
hdd <- subset(hdd, year > 1999)

noaa_cleaned <- merge(precip,temp, by=c("state","div","year"))
noaa_cleaned <- merge(noaa_cleaned,pdsi, by=c("state","div","year"))
  # Note: Drought indices include data for non-state territories
  # so the number of observations is greater.  
  # The cleaned data set includes only states.
noaa_cleaned <- merge(noaa_cleaned,phdi, by=c("state","div","year"))
noaa_cleaned <- merge(noaa_cleaned,zndx, by=c("state","div","year"))
noaa_cleaned <- merge(noaa_cleaned,cdd, by=c("state","div","year"))
noaa_cleaned <- merge(noaa_cleaned,hdd, by=c("state","div","year"))


write.csv(noaa_cleaned, "noaa_cleaned.csv", col.names=TRUE, row.names = FALSE)
