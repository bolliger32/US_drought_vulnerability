# Title: Makefile
# Inputs:
# Outputs:
# Authors: Ian Bolliger (bolliger@berkeley.edu)
# Date: Apr 25, 2016
# Description: Master Makefile to run data downloading & cleaning, 
	# plus analysis. NOTE: See the following Readme's for datasets 
	# that require manual "point-and-click" downloading:
		# data/mortality/README.md
		# data/drought_monitor/README.md
		# data/yield/README.md
		# data/acs/README.md
# Note: Currently, dependencies that require big files
	# that have not been shared throughout the group 
	# are commented out. To replicate study from beginning,
	# uncomment those scripts, make sure all files are in
	# appropriate place, and "make all"
############################

## Environment-specific commands
PYTHONCOMMAND=python
STATACOMMAND=stata -e do


## Analysis parameters
# Number of years of cumulative drought to capture for drought metric
DM_LAGS=1 3 5


## Filepaths
DATA_DIR=$(realpath ../data)

MORT_DIR=$(DATA_DIR)/mortality
RAW_MORT_DIR=$(MORT_DIR)/raw
MORT_DATA_CLEANED=$(MORT_DIR)/mortality_cleaned.csv

UNEMP_DIR=$(DATA_DIR)/unemployment
RAW_UNEMP_DIR=$(UNEMP_DIR)/raw
UNEMP_DATA_RAW=$(RAW_UNEMP_DIR)/*.txt
UNEMP_DATA_CLEANED=$(UNEMP_DIR)/unemploymentClean.csv

ACS_DIR=$(DATA_DIR)/acs
ACS_DATA_RAW=$(ACS_DIR)/acs.csv
ACS_DATA_CLEANED=$(ACS_DIR)/summarized_acs.csv

EPA_DIR=$(DATA_DIR)/epa
RAW_EPA_DIR=$(EPA_DIR)/raw
EPA_DATA_RAW=$(addprefix $(RAW_EPA_DIR)/,NATIONAL_FACILITY_FILE.CSV NATIONAL_SIC_FILE.CSV)
EPA_DATA_CLEANED=$(EPA_DIR)/clean_epa.csv

NARR_DATA_RAW=$(addprefix $(DATA_DIR)/narr/raw/,narr_readme.txt narr_precip.nc narr_temp.nc)

RURAL_URBAN_RAW=$(DATA_DIR)/rural/rural.csv

DM_DIR=$(DATA_DIR)/drought_monitor
RAW_DM_DIR=$(DM_DIR)/raw
PROCESSED_DM_DIR=$(DM_DIR)/processed
DM_DATA_SUMMARIZED=$(addsuffix .csv,$(addprefix $(DM_DIR)/weekly_,no_drought DM_0 DM_1 DM_2 DM_3 DM_4))
COUNTY_AREA=$(DM_DIR)/county_area.csv
DM_DATA_CLEANED=$(addprefix $(DM_DIR)/drought_indicator_,$(addsuffix year_matrics_reformat.csv,$(DM_LAGS)))
# indicator that drought monitor processing steps have completed
DM_DATA_PROCESSED_IND=$(PROCESSED_DM_DIR)/temp.shp

YIELD_DIR=$(DATA_DIR)/yield
RAW_YIELD_DIR=$(YIELD_DIR)/raw
YIELD_DATA_RAW=$(RAW_YIELD_DIR)/*.csv
YIELD_DATA_CLEANED=$(YIELD_DIR)/NASS_all.csv


DATA_MERGED=$(DATA_DIR)/data_combined.csv


LOOKUP_TABLE=$(DATA_DIR)/county_ID_lookup_table.csv


DOWNLOAD_SCRIPTS=download
CLEAN_SCRIPTS=clean
MERGE_SCRIPTS=merge

############################

.PHONY: all download data merge test stage1 stage2 visualization shiny report 

all: report

############################

## Download data (note that some data downloads need to happen manually - 
## see header for details)
download : $(UNEMP_DATA_RAW) $(ACS_DATA_RAW) $(NARR_DATA_RAW) $(RURAL_URBAN_RAW)

# Download raw unemployment data
$(UNEMP_DATA_RAW) : $(DOWNLOAD_SCRIPTS)/download_unemployment.R
	Rscript $<
	
# Download raw acs data
# NOTE: need to also download x-walks manually before cleaning data
$(ACS_DATA_RAW): $(DOWNLOAD_SCRIPTS)/download_acs_data.R
	Rscript $<
	
# Download raw NARR data
$(word 1,$(NARR_DATA_RAW)) : $(DOWNLOAD_SCRIPTS)/download_narr_data.R
	Rscript $<
	
# Download raw urban/rural data
$(RURAL_URBAN_RAW) : $(DOWNLOAD_SCRIPTS)/download_population_area.R
	Rscript $<

# Clean downloaded data
cleandownload : 
	-rm $(UNEMP_DATA_RAW) $(ACS_DATA_RAW) $(NARR_DATA_RAW) $(RURAL_URBAN_RAW)

############################

## Clean Data
data : $(MORT_DATA_CLEANED) $(UNEMP_DATA_CLEANED) $(ACS_DATA_CLEANED) $(EPA_DATA_CLEANED) $(YIELD_DATA_CLEANED) $(DM_DATA_CLEANED)

# Clean raw mortality data
$(MORT_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_county_mortality_data.py $(RAW_MORT_DIR)/*.txt
	$(PYTHONCOMMAND) $< $(RAW_MORT_DIR) $@

# Clean raw unemployment data	
$(UNEMP_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_unemployment.R $(UNEMP_DATA_RAW)
	Rscript $<

# Clean ACS data
$(ACS_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_acs.R $(ACS_DATA_RAW)
	Rscript $<
	
# Clean EPA data
#$(EPA_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_epa.R $(EPA_DATA_RAW)
#	Rscript $< $@ $(RAW_EPA_DIR)

# Decompose drought monitor polygons to county level
#$(DM_DATA_PROCESSED_IND) : $(CLEAN_SCRIPTS)/decompose_drought_monitor_to_county.py $(RAW_DM_DATA_DIR)/*
#	$(PYTHONCOMMAND) $< $(RAW_DM_DATA_DIR)
# summarize weekly drought monitor metrics
#$(word 1,$(DM_DATA_SUMMARIZED)) : $(CLEAN_SCRIPTS)/summarize_decomposed_weekly_DM.py $(DM_DATA_PROCESSED_IND)
#	$(PYTHONCOMMAND) $< $(DM_DIR) $(PROCESSED_DM_DIR)
# Get drought indicator from summarized weekly DM statistics
$(DM_DIR)/drought_indicator_%year_matrics_reformat.csv : $(CLEAN_SCRIPTS)/get_drought_indicator.py $(COUNTY_AREA) $(DM_DATA_SUMMARIZED)
	$(PYTHONCOMMAND) $< $(@D) $(subst $(DM_DIR)/drought_indicator_,,$(subst year_matrics_reformat.csv,,$@)) --county_area $(word 2,$^)

# Clean yield data
$(YIELD_DATA_CLEANED) : $(CLEAN_SCRIPTS)/compile_NASS_yield.do $(YIELD_DATA_RAW)
	$(STATACOMMAND) $<

cleandata:
	-rm $(MORT_DATA_CLEANED) $(UNEMP_DATA_CLEANED) $(ACS_DATA_CLEANED) $(EPA_DATA_CLEANED) $(YIELD_DATA_CLEANED) $(DM_DATA_CLEANED) $(PROCESSED_DM_DIR)/*

############################

## Merge data prior to stage1
merge : $(DATA_MERGED)

$(DATA_MERGED) : $(MERGE_SCRIPTS)/merge_data_for_stage_1.py data
	$(PYTHONCOMMAND) $< $@ --mort $(MORT_DATA_CLEANED) --dm $(DM_DATA_CLEANED) --unemp $(UNEMP_DATA_CLEANED) --lookup $(LOOKUP_TABLE) --yield $(YIELD_DATA_CLEANED)
	
cleanmerge:
	-rm $(DATA_MERGED)

############################

## Run Stage 1


############################

clean: cleandownload cleandata cleanmerge

############################

test:
	cd code/analysis_stage1 && make permutationTests

stage2:
	cd data && make stage2

visualization:
	cd data && make visualization

shiny:
	cd code/utils/scripts && python eda.py
	cd code/utils/scripts && python hist-outliers_script.py

analysis:
	make permutationTests
	make stage1 
	make stage2

report:
	cd paper && make all
	cd paper && make clean
