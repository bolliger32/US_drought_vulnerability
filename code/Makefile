# Title: Makefile
# Inputs:
# Outputs:
# Authors: Ian Bolliger (bolliger@berkeley.edu)
# Date: Apr 25, 2016
# Description: Master Makefile to run data downloading & cleaning, 
	# plus analysis. NOTE: See the following Readme's for datasets 
	# that require manual "point-and-click" downloading:
		# data/mortality/README.md
		# data/drought_monitor/README.md
		# data/yield/README.md
		# data/acs/README.md
# Note: Currently, dependencies that require big files
    # that have not been shared throughout the group 
    # are commented out. To replicate study from beginning,
    # uncomment those scripts, make sure all files are in
    # appropriate place, and "make all"
############################

## Filepaths
DATA_DIR=$(realpath ../data)

MORT_DIR=$(DATA_DIR)/mortality
RAW_MORT_DIR=$(MORT_DIR)/raw
MORT_DATA_CLEANED=$(MORT_DIR)/mortality_cleaned.csv

UMEMP_DIR=$(DATA_DIR)/unemployment
UNEMP_DATA_RAW=$(UMEMP_DIR)/raw/*.txt
UNEMP_DATA_CLEANED=$(UMEMP_DIR)/unemploymentClean.csv

ACS_DIR=$(DATA_DIR)/acs
ACS_DATA_RAW=$(ACS_DIR)/acs.csv
ACS_DATA_CLEANED=$(ACS_DIR)/summarized_acs.csv

EPA_DIR=$(DATA_DIR)/epa
RAW_EPA_DIR=$(EPA_DIR)/raw
EPA_DATA_RAW=$(addprefix $(RAW_EPA_DIR)/,NATIONAL_FACILITY_FILE.CSV NATIONAL_SIC_FILE.CSV)
EPA_DATA_CLEANED=$(EPA_DIR)/clean_epa.csv

NARR_DATA_RAW=$(addprefix $(DATA_DIR)/narr/raw/,narr_readme.txt narr_precip.nc narr_temp.nc)

RURAL_URBAN_RAW=$(DATA_DIR)/rural/rural.csv

DM_DIR=$(DATA_DIR)/drought_monitor
RAW_DM_DIR=$(DM_DIR)/raw
DM_DATA_PROCESSED=$(DM_DIR)/processed_drought_monitor_data/temp.shp

DOWNLOAD_SCRIPTS=download
CLEAN_SCRIPTS=clean

############################

.PHONY: all download data test stage1 stage2 visualization shiny report 

all: report

############################

## Download data (note that some data downloads need to happen manually - 
## see header for details)
download : $(UNEMP_DATA_RAW) $(ACS_DATA_RAW) $(NARR_DATA_RAW) $(RURAL_URBAN_RAW)

# Download raw unemployment data
$(UNEMP_DATA_RAW) : $(DOWNLOAD_SCRIPTS)/download_unemployment.R
 	Rscript $<
	
# Download raw acs data
# NOTE: need to also download x-walks manually before cleaning data
$(ACS_DATA_RAW): $(DOWNLOAD_SCRIPTS)/download_acs_data.R
	Rscript $<
	
# Download raw NARR data
$(word 1,$(NARR_DATA_RAW)) : $(DOWNLOAD_SCRIPTS)/download_narr_data.R
	Rscript $<
	
# Download raw urban/rural data
$(RURAL_URBAN_RAW) : $(DOWNLOAD_SCRIPTS)/download_population_area.R
	Rscript $<

# Clean downloaded data
cleandownload : 
	rm $(UNEMP_DATA_RAW) $(ACS_DATA_RAW) $(NARR_DATA_RAW) $(RURAL_URBAN_RAW)

############################

## Clean Data
data : $(MORT_DATA_CLEANED) $(UNEMP_DATA_CLEANED) $(ACS_DATA_CLEANED)

# Clean raw mortality data
$(MORT_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_county_mortality_data.py $(RAW_MORT_DIR)/*.txt
	python $< $(RAW_MORT_DIR) $@

# Clean raw unemployment data	
$(UNEMP_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_unemployment.R $(UNEMP_DATA_RAW)
	Rscript $<

# Clean ACS data
$(ACS_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_acs.R $(ACS_DATA_RAW)
	Rscript $<
	
# Clean EPA data
#$(EPA_DATA_CLEANED) : $(CLEAN_SCRIPTS)/clean_epa.R $(EPA_DATA_RAW)
#	Rscript $< $@ $(RAW_EPA_DIR)

# Decompose drought monitor polygons to county level
#$(DM_DATA_PROCESSED) : $(CLEAN_SCRIPTS)/decompose_drought_monitor_to_county.py $(RAW_DM_DATA_DIR)/*
#    python $< $(RAW_DM_DATA_DIR)
	
cleandata:
	rm $(MORT_DATA_CLEANED) $(UNEMP_DATA_CLEANED) $(ACS_DATA_CLEANED) $(EPA_DATA_CLEANED)

############################

clean: cleandownload cleandata

############################

test:
	cd code/analysis_stage1 && make permutationTests
	
stage1:
	cd data && make stage1

stage2:
	cd data && make stage2

visualization:
	cd data && make visualization

shiny:
	cd code/utils/scripts && python eda.py
	cd code/utils/scripts && python hist-outliers_script.py

analysis:
	make permutationTests
	make stage1 
	make stage2

report:
	cd paper && make all
	cd paper && make clean
