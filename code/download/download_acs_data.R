######HEADER
#clean_acs.r
#Inputs
  #acs person and household data from 2005-2014, downloaded in this file
  #a csv of state name, downloaded in this file
  #a crosswalk between PUMAs and counties that must be dowloaded by the user befroe running this file
#Cleaned acs data
#Hal Gordon and Dan Blausteun-Rejto
#April 4, 2016
#For more information, see data/acs/acs_readme

library(dplyr)
library(readr)
library(maptools)
library(downloader)

###Unfortunetly, the crosswalks cannot be directly downloaded from the internetin the r file.
###To download files, you must go to http://mcdc.missouri.edu/websas/geocorr14.html
###Two crosswalks are necessary, since PUMAs were recoded after the 2010 census
###For ACS 2012-2014, select all states, and then 'PUMA("2012")' on the RHS and 'County 2014' on the LHS.
###Weight by population 2010, and then run request for a CSV file
###For ACS 2005-2011, select 'PUMA(2000--used in ACS data thru Vintage 2011)' instead
###Delete the second row, then:
###Save the csvs as crosswalk2012.csv and crosswalk2000.csv 

#insheet the crosswalks

  crosswalk2012 = read_csv("crosswalk2012.csv")
  names(crosswalk2012)[1] <-"ST"
  names(crosswalk2012)[2] <-"PUMA"
  names(crosswalk2012)[3] <-"county"
  names(crosswalk2012)[5] <-"cntyname"
  crosswalk2000 = read_csv("crosswalk2000.csv")
  names(crosswalk2000)[1] <-"ST"
  names(crosswalk2000)[2] <-"PUMA"
  names(crosswalk2000)[3] <-"county"
  names(crosswalk2000)[5] <-"cntyname"

##download csv of state abbreviations if not downloaded yet
if (file.exists("state_lookup_table.csv")==F){ 
  download("http://www.fonz.net/blog/wp-content/uploads/2008/04/states.csv","state_lookup_table.csv", mode="wb")
}

state = read.csv("state_lookup_table.csv",1,stringsAsFactors=FALSE) 

# download data -----------------------------------------------------------
##if data haven't been downloaded yet, download it
  
  #date range = 2005:2014
  pDFlist <- list()
  hDFlist <- list()
  DFlist <- list()
  
  for (row in 1:51) {  #download sample data for testing code
    ST = tolower(state$Abbreviation[row])
    STATE = state$Abbreviation[row]
    #ST is the current state abbreviation

    # year loop
    for (year in 2005:2014){
      
      if (year<= 2006) {
        urlp = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/", toString(year),"/csv_"
                   ,"p",ST,".zip") 
        urlh = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/", toString(year),"/csv_"
                      ,"h",ST,".zip") 
      } else {
        urlp = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/",toString(year),
                     "/1-Year/csv_","p",ST,".zip")
        urlh = paste0("http://www2.census.gov/programs-surveys/acs/data/pums/",toString(year),
                     "/1-Year/csv_","h",ST,".zip")
      }
      
      file_namep = paste0("data/acs/",ST,"_",toString(year),"_p")
      file_nameh = paste0("data/acs/",ST,"_",toString(year),"_h")
      download(urlp,file_namep, mode="wb")
      download(urlh,file_nameh, mode="wb")
      
      #unzip only csv's into 1 directory
      unzip (file_namep, exdir = "acs_raw")
      unzip (file_nameh, exdir = "acs_raw")
      #delete zip
      unlink(file_namep)
      unlink(file_nameh)
      
      #**CLEAN- remove extraneous columns to reduce file size**
      #**PERSONAL**
      yr <- year-2000
      YR <- substr(toString(year),3,4)
      yr_0 <- yr-4
      st_0 <- row-1
      yr_st <- st_0*10+yr_0
      
      #**PERSONAL**
      #**PERSONAL**
      #**PERSONAL**
      csvname <- paste0("acs_raw/ss",YR,"p",ST,".csv")
      df <- read_csv(csvname)
        # Keep the variables of interest:
          #PWGTP: Weight
          #AGEP: Age
            #numeric
          #HISP: Hispanic:
            #01: Not Spanish/Hispanic/Latino;
            #02-24: Everything else;
          #RAC1P: Race:
          #               1  White alone
          #               2  Black or African American alone
          #               3  American Indian alone
          #               4  Alaska Native alone
          #               5  American Indian and Alaska Native and no other races
          #               6  Asian alone
          #               7  Native Hawaiian and Other Pacific Islander alone
          #               8  Some other race alone
          #               9  Two or more major race groups     
          #SEX: Sex
            #1: Male
            #2: Female
          #PUMA: Puma
          #ST: state
          #NAICSP: NAICS Industry code of employment
            #111: AGR-Crop Production
            #112: AGR-Animal Production and Aquaculture
      pkeep <- c("PUMA", "ST", "PWGTP", "AGEP", "HISP", "RAC1P", "SEX", "NAICSP")
      pDFlist[[yr_st]] <- read_csv(csvname)[,pkeep] %>% mutate(year=year)
          pDFlist[[yr_st]]$PUMA <- as.numeric(pDFlist[[yr_st]]$PUMA)
          pDFlist[[yr_st]]$ST <- as.numeric(pDFlist[[yr_st]]$ST) 
          pDFlist[[yr_st]]$PWGTP <- as.numeric(pDFlist[[yr_st]]$PWGTP)
          pDFlist[[yr_st]]$AGEP <- as.numeric(pDFlist[[yr_st]]$AGEP) 
          pDFlist[[yr_st]]$HISP <- as.numeric(pDFlist[[yr_st]]$HISP)
      #Generate new variables (including the weights)
          #age
            age5 = pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$AGEP<=5,1,0)
            age65 = pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$AGEP>=65,1,0)
          #Hispanic
            eth_hispanic <- pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$HISP==1,0,1)
          #Race
            race_white <- pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$RAC1P==1,1,0)
            race_black <- pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$RAC1P==2,1,0)
          #Male
            sex_male <- pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$SEX==1,1,0)
          #Industry
            work_crops_ranch <- pDFlist[[yr_st]]$PWGTP*ifelse(pDFlist[[yr_st]]$NAICSP=='111' | pDFlist[[yr_st]]$NAICSP=='112',1,0)
          #add them into the list
            pDFlist[[yr_st]] <- mutate(pDFlist[[yr_st]], 
                                 age5 = age5,
                                 age65 = age65,
                                 eth_hispanic = eth_hispanic,
                                 race_white = race_white,
                                 race_black = race_black,
                                 sex_male = sex_male,
                                 work_crops_ranch = work_crops_ranch
                                 )
      #delete uneeded columns
          keepsp <- c("PUMA", "ST", "PWGTP","age5","age65","eth_hispanic",
                     "race_white","race_black","sex_male","work_crops_ranch", "year")
          pDFlist[[yr_st]] <- pDFlist[[yr_st]][keepsp]
      #Now delete the old csv file
      unlink(csvname)
      #PERSON COLLAPSE#
      #PERSON COLLAPSE#
      #PERSON COLLAPSE#
      pDFlist[[yr_st]] <- pDFlist[[yr_st]] %>% mutate(work_NA = ifelse(is.na(work_crops_ranch),0,1),
                                              work_PWGTP = PWGTP*work_NA)
      grp_cols <- c('PUMA', 'ST', 'year')
      dots <- lapply(grp_cols, as.symbol)
      
      pDFlist[[yr_st]] <- pDFlist[[yr_st]] %>% group_by_(.dots=dots) %>%
        summarise(PWGTP = sum(PWGTP, na.rm=TRUE),
                  age5 = sum(age5, na.rm=TRUE),
                  age65 =sum(age65, na.rm=TRUE),
                  eth_hispanic =sum(eth_hispanic, na.rm=TRUE),
                  race_white =sum(race_white, na.rm=TRUE),
                  race_black =sum(race_black, na.rm=TRUE),
                  sex_male =sum(sex_male, na.rm=TRUE),
                  work_crops_ranch =sum(work_crops_ranch, na.rm=TRUE),
                  work_PWGTP = sum(work_PWGTP, na.rm=TRUE)
        ) 
#       %>%
#         mutate(age5 = age5/PWGTP,
#                age65 = age65/PWGTP,
#                eth_hispanic = eth_hispanic/PWGTP,
#                race_white = race_white/PWGTP,
#                race_black = race_black/PWGTP,
#                sex_male = sex_male/PWGTP,
#                work_crops_ranch = work_crops_ranch/work_PWGTP
#         )
      #keep vars of interest
      #pDFlist[[yr_st]] <- pDFlist[[yr_st]][keepsp]
      
      
      
      
      #**HOUSEHOLD**
      #**HOUSEHOLD**
      #**HOUSEHOLD**
      csvname <- paste0("acs_raw/ss",YR,"h",ST,".csv")
      df <- read_csv(csvname)
        # Keep the variables of interest:
          #WGTP: Weight
          #PUMA: Puma
          #ST: state
          #NP: Number of People
          #WATP: Water (yearly cost)
            #       0  N/A (GQ/vacant)
            #       0001  Included in rent or in condo fee
            #       0002  No charge
            #       0003:9999  $3 to $9999 (Rounded and top-coded)
          #HINCP: Household income
            #       -00060000  N/A(GQ/vacant)
            #       -00059999  Loss of -$59,999 or more
            #       -00059998:-00000001  Loss of $1 to -$59,998
            #       000000000  No household income
            #       000000001  $1 or Break even
            #       000000002:999999999  Total household income in dollars 
          #TEN: Housing tenure
            #       0  N/A  (GQ/vacant)
            #       1  Owned with mortgage or loan (include home equity loans)
            #       2  Owned Free And Clear
            #       3  Rented
            #       4  Occupied without payment of rent
      hkeep <- c("PUMA", "ST", "NP", "WGTP", "WATP", "HINCP", "TEN")
      hDFlist[[yr_st]] <- read_csv(csvname)[,hkeep] %>% mutate(year=year)
           hDFlist[[yr_st]]$PUMA <- as.numeric(hDFlist[[yr_st]]$PUMA)
           hDFlist[[yr_st]]$ST <- as.numeric(hDFlist[[yr_st]]$ST)
           hDFlist[[yr_st]]$NP <- as.numeric(hDFlist[[yr_st]]$NP)
           hDFlist[[yr_st]]$WGTP <- as.numeric(hDFlist[[yr_st]]$WGTP)
           hDFlist[[yr_st]]$WATP <- as.numeric(hDFlist[[yr_st]]$WATP)
           hDFlist[[yr_st]]$HINCP <- as.numeric(hDFlist[[yr_st]]$HINCP)
      #Generate new variables (including the weights)
          #Weights
           hDFlist[[yr_st]]$WGTP = ifelse(hDFlist[[yr_st]]$NP==0,NA,hDFlist[[yr_st]]$WGTP)
          #Water: keep only if you have a bill
           hDFlist[[yr_st]]$WATP = hDFlist[[yr_st]]$WGTP*ifelse(hDFlist[[yr_st]]$WATP==1 | hDFlist[[yr_st]]$WATP==2,NA,hDFlist[[yr_st]]$WATP)
          #Income
           hDFlist[[yr_st]]$HINCP = hDFlist[[yr_st]]$WGTP*hDFlist[[yr_st]]$HINCP
          #Tenure
           tenure_owned = hDFlist[[yr_st]]$WGTP*ifelse(hDFlist[[yr_st]]$TEN==1 | hDFlist[[yr_st]]$TEN==2,1,0)
          #add them into the list
           hDFlist[[yr_st]] <- mutate(hDFlist[[yr_st]], 
                                      tenure_owned = tenure_owned
                                )
           #delete uneeded columns
           keepsh <- c("PUMA", "ST", "year", "WGTP", "WATP", "HINCP", "tenure_owned")
           hDFlist[[yr_st]] <- hDFlist[[yr_st]][keepsh]
      #Now delete the old csv file
      unlink(csvname)
      
      #HOUSEHOLD COLLAPSE#
      #HOUSEHOLD COLLAPSE#
      #HOUSEHOLD COLLAPSE#
      hDFlist[[yr_st]] <- hDFlist[[yr_st]] %>% mutate(WATP_NA = ifelse(is.na(WATP),0,1),
                                              WATP_WGTP = WGTP*WATP_NA,
                                              HINCP_NA = ifelse(is.na(HINCP),0,1),
                                              HINCP_WGTP = WGTP*HINCP_NA,
                                              tenure_NA = ifelse(is.na(tenure_owned),0,1),
                                              tenure_WGTP = WGTP*tenure_NA)
      hDFlist[[yr_st]] <- hDFlist[[yr_st]] %>% group_by_(.dots=dots) %>%
        summarise(WGTP = sum(WGTP, na.rm=TRUE),
                  WATP = sum(WATP, na.rm=TRUE),
                  WATP_WGTP = sum(WATP_WGTP, na.rm=TRUE),
                  HINCP =sum(HINCP, na.rm=TRUE),
                  HINCP_WGTP =sum(HINCP_WGTP, na.rm=TRUE),
                  tenure_owned =sum(tenure_owned, na.rm=TRUE),
                  tenure_WGTP =sum(tenure_WGTP, na.rm=TRUE)
        ) 
#       %>%
#         mutate(WATP = WATP/WATP_WGTP,
#                HINCP = HINCP/HINCP_WGTP,
#                tenure_owned = tenure_owned/tenure_WGTP
#         )
      #keep only variables of interest
      #hDFlist[[yr_st]] <- hDFlist[[yr_st]][keepsh]
      
      ###
      ###Now, merge the collapsed person and household files
      ###
      
      mergeby <- c('PUMA', 'ST', 'year')
      DFlist[[yr_st]] <- merge(pDFlist[[yr_st]], hDFlist[[yr_st]], by= mergeby)
      
      ###
      ### merge with the crosswalk
      ###
      joinby <- c('PUMA', 'ST')
      
      if (year<=2011) {
        cross_merge <- crosswalk2000[crosswalk2000$stab==STATE,]
      } else {
        cross_merge <- crosswalk2012[crosswalk2012$stab==STATE,]
      }
      #join and weight
      DFlist[[yr_st]] <- inner_join(cross_merge, DFlist[[yr_st]], by=joinby, type='left', match='all') %>%
                      mutate(PWGTP = PWGTP*afact,
                             age5 = age5*afact,
                             age65 = age65*afact,
                             eth_hispanic = eth_hispanic*afact,
                             race_white = race_white*afact,
                             race_black = race_black*afact,
                             sex_male = sex_male*afact,
                             work_crops_ranch = work_crops_ranch*afact,
                             work_PWGTP = work_PWGTP*afact,
                             WGTP = WGTP*afact,
                             WATP = WATP*afact,
                             WATP_WGTP = WATP_WGTP*afact,
                             HINCP = HINCP*afact,
                             HINCP_WGTP = HINCP_WGTP*afact,
                             tenure_owned = tenure_owned*afact,
                             tenure_WGTP = tenure_WGTP*afact
                             )
      #Summ and collapse
      grp_cols <- c('county', 'ST', 'cntyname')
      dots <- lapply(grp_cols, as.symbol)
      
      DFlist[[yr_st]] <- DFlist[[yr_st]] %>% group_by_(.dots=dots) %>%
      summarise(PWGTP = sum(PWGTP, na.rm=TRUE),
                age5 = sum(age5, na.rm=TRUE),
                age65 =sum(age65, na.rm=TRUE),
                eth_hispanic =sum(eth_hispanic, na.rm=TRUE),
                race_white =sum(race_white, na.rm=TRUE),
                race_black =sum(race_black, na.rm=TRUE),
                sex_male =sum(sex_male, na.rm=TRUE),
                work_crops_ranch =sum(work_crops_ranch, na.rm=TRUE),
                work_PWGTP = sum(work_PWGTP, na.rm=TRUE),
                WGTP = sum(WGTP, na.rm=TRUE),
                WATP = sum(WATP, na.rm=TRUE),
                WATP_WGTP = sum(WATP_WGTP, na.rm=TRUE),
                HINCP =sum(HINCP, na.rm=TRUE),
                HINCP_WGTP =sum(HINCP_WGTP, na.rm=TRUE),
                tenure_owned =sum(tenure_owned, na.rm=TRUE),
                tenure_WGTP =sum(tenure_WGTP, na.rm=TRUE)
      ) %>%
        mutate(age5 = age5/PWGTP,
               age65 = age65/PWGTP,
               eth_hispanic = eth_hispanic/PWGTP,
               race_white = race_white/PWGTP,
               race_black = race_black/PWGTP,
               sex_male = sex_male/PWGTP,
               work_crops_ranch = work_crops_ranch/work_PWGTP,
               WATP = WATP/WATP_WGTP,
               HINCP = HINCP/HINCP_WGTP,
               tenure_owned = tenure_owned/tenure_WGTP
        )
    }
  } 

#combine 
acs_df <- rbind_all(DFlist)
  acs_df$county <- as.character(acs_df$county)
  substrRight <- function(x, n){
    substr(x, nchar(x)-n+1, nchar(x))
  }
  acs_df$county <- substrRight(acs_df$county, 3)
    names(acs_df)[1] <-"COUNTYFP10"
    names(acs_df)[2] <-"STATEFP10"
write.csv(acs_df, file = "data/acs/acs.csv")
