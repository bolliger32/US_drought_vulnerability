wd="~/Desktop/US_drought_vulnerability/data"
setwd(wd)

combined<-read.csv("data_combined.csv")
names(combined)
runs=length(unique(combined$GISJOIN))
counties=as.character(unique(combined$GISJOIN))

### not x=13, y=10 means x=drought_3year, y=deaths_all_b
## need to do all other combinations, just laying out framework
## should be straight forward from here to change
## probably only need the last ABTS model, but wanted to see the build up


## y_{i,t}=\beta_i D_{i,t}+\alpha_i
## mod.2=lm(rate_adj_all_b~drought_3year*as.factor(GISJOIN),data=combined)

## i: index to loop over counties
## x: column number of predictor variable
## y: column number of response variable
forParallelMod_AB=function(i,x,y){
  
  sub=subset(combined,GISJOIN==counties[i])
  
  mod_AB=lm(sub[,y]~sub[,x])
  return(mod_AB)
}

names(combined)

require(parallel)

## test
testMini=mclapply(cbind(1:2),FUN=forParallelMod_AB,x=13,y=10,mc.cores=6)
testMini

## don't use all the cores so I can still work while this is running
modelAB=mclapply(cbind(1:runs),FUN=forParallelMod_AB,x=13,y=10,mc.cores=6)


forParallelMod_ABT=function(i,x,y){
  sub=subset(combined,GISJOIN==counties[i])
  
  mod_ABT=lm(sub[,y]~sub[,x]+sub$year)
  return(mod_ABT)
}

testMini=mclapply(cbind(1:2),FUN=forParallelMod_ABT,x=13,y=10,mc.cores=6)
testMini

## don't use all the cores so I can still work while this is running
modelABT=mclapply(cbind(1:runs),FUN=forParallelMod_ABT,x=13,y=10,mc.cores=6)
save(modelABT,file="mod_ABT_full.Rda")

stateID=length(unique(combined$STATEFP10))
states=unique(combined$STATEFP10)



forParallelMod_ABTS=function(i,x,y){
  sub=subset(combined,STATEFP10==states[i])
    if(i==9){
      mod_ABTS=lm(sub[,y]~sub[,x]+sub$year) 
      
    }else{
  
    mod_ABTS=lm(sub[,y]~sub[,x]*as.factor(sub$GISJOIN)+sub$year) 
    ## need to confirm that the "intercept" is the gamma term we want
   }

  return(mod_ABTS)
}

## at least one state has only one county represented, giving an error
checkFactorL<-c()
for(i in 1:stateID){
  sub=subset(combined,STATEFP10==states[i])
 checkFactorL<-c(checkFactorL,length(unique(sub$GISJOIN)))
}
which(checkFactorL==1) ## 9

testMini=mclapply(cbind(3:4),FUN=forParallelMod_ABTS,x=13,y=10,mc.cores=6)
testMini

## don't use all the cores so I can still work while this is running
modelABTS=mclapply(cbind(1:stateID),FUN=forParallelMod_ABTS,x=13,y=10,mc.cores=6)
save(modelABTS,file="mod_ABTS_full.Rda")
