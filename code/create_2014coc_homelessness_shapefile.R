## homelessness data CoC combine
## DBR
## 2016-03-15

wd="~/Desktop/drought_project/data/homeless" ## replace with your own path name
setwd(wd)

require(xlsx)
require(maptools)
require(downloader)

## download from here:
## https://www.hudexchange.info/resource/3031/pit-and-hic-data-since-2007/

# coc = continuum of care
byCoC=read.xlsx("2007-2015-PIT-Counts-by-CoC.xlsx",1,stringsAsFactors=FALSE)


cocs_dir = "~/desktop/drought_project/data/homeless/cocs" #replace with your own path name 
setwd(cocs_dir)

##Combine CoC Shapefiles and Assign 2014 Homeless Pop Value to ARD Column

#start combining shapefiles with attribute for homeless population (currently replacing 
#existing  attribute since I don't know how to add one )
setwd(cocs_dir)
all_cocs = readShapePoly("DC/District_of_Columbia/DC_500/DC_500.shp")
all_cocs = all_cocs[,-(6:10)]  #removes extraneous shapefile attributes

#set ARD value to DC pop value from byCoC (since I don't know how to create new attribute)
number_CoCs = length(byCoC$"CoC.Number")-2
all_cocs$ARD = byCoC$"Total.Homeless..2015"[70]

## template code to loop through CoC table for homeless pop value
#for (i in 1:number_CoCs){
 # if (byCoC$"CoC.Number"[i] == "DC-500"){
    #all_cocs$ARD = byCoC$"Total.Homeless..2015"[i]
  #}
#}


all_state_folders = list.files()
for (row in 1:length(all_state_folders)) {  #replace state$abbeviation with state name if necessary
#for (row in 1:4) {   #smaller loop for testing code
  #ST = state$abbreviation[row] #abbreviation name
  current_state_folder = all_state_folders[row]
  setwd(current_state_folder)
  
  # extra code to handle mistake in downloading original CoCs
  extra_folder = list.files()
  setwd(extra_folder) 
  sub_folders = list.files()
  for (file in 1:length(sub_folders)){
    if (sub_folders[file] != "metadata") {
      setwd(sub_folders[file])
      shape_file = paste(sub_folders[file],".shp",sep="")
      thisCoC = readShapePoly(shape_file) 
      thisCoC = thisCoC[,-(6:10)] #removes extraneous shapefile attributes
      
      #assigns homeless pop value to ARD col
      for (i in 1:number_CoCs) {
        CoC_num = chartr("-","_",byCoC$"CoC.Number"[i])  #makes CoC number in byCoC match number in folder name
        if (CoC_num == sub_folders[file]) {
          print(byCoC$"Total.Homeless..2015"[i])
          thisCoC$ARD = byCoC$"Total.Homeless..2015"[i]
        
        }
      }
      
      #appends shapefile to all CoC shapefile
      all_cocs = rbind(all_cocs,thisCoC,makeUniqueIDs = TRUE)  
      setwd('..') # move to parent directory, folder with full state name and all shapefile folders
    }
  }
  setwd('..') # move to parent directory, folder with state abbreviation name
  setwd('..') # move to parent directory, folder with all state folders
}

save.image("~/Desktop/drought_project/data/homeless/2014_coc_shapefile_data.RData")