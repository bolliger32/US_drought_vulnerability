## homelessness data CoC combine
## DBR
## 2016-03-18

wd="~/Desktop/drought_project/data/homeless" ## replace with your own path name
setwd(wd)

require(xlsx)
require(maptools)
require(downloader)

# coc = continuum of care

##Import point in time hoemless data
byCoC=read.xlsx("PIT_Counts.xlsx",1,stringsAsFactors=FALSE)

cocs_dir = "~/desktop/drought_project/data/homeless/raw" #replace with your own path name 
setwd(cocs_dir)

##Combine CoC Shapefiles and Assign 2014 Homeless Pop Value to ARD Column
# This should be updated to create a new column, perhaps using package Rgdal and
# SpatialDataFrameName@data[[“colname”]] = col data where col data is a 1 column matrix
# with the same number as rows as SpatialDataFrameName@data

#start combining shapefiles with attribute for homeless population (currently replacing 
#existing  attribute since I don't know how to add one )
setwd(cocs_dir)
#first_coc = list.files(list.files()[1])[1]
# first_coc = file.path("Alabama","AL_500","AL_500.shp",fsep="/")
# all_cocs2 = readShapePoly(first_coc)
#all_cocs2 = all_cocs2[,-(5:10)]  #removes extraneous shapefile attributes

#set ARD value to DC pop value from byCoC (since I don't know how to create new attribute)
number_CoCs = length(byCoC$"CoC.Number")-2

#all_cocs2$ARD = byCoC$"Total.Homeless..2015"[70]


#all_cocs2@data$TotalHomeless15=5 ## code to add a new column to the data held within a shapefile
## making one giant shape file from each CoC
setwd(paste(wd,"raw",sep="/"))
all_state_folders = list.files()
orderedState=state[order(state[,2]),]

## start it off row=1
setwd(cocs_dir)
current_state_folder = all_state_folders[1]
setwd(paste(current_state_folder,orderedState[1,1],sep="/")) ## added to account for extra nested folder
sub_folders = list.files()

## start if off file=1
if (sub_folders[1] != "metadata") {
  setwd(sub_folders[1])
  shape_file = paste(sub_folders[1],".shp",sep="")
  thisCoC = readShapePoly(shape_file) 
  
  
  #starts one big shapefile to all CoC shapefile
  all_cocs2 = thisCoC
  
}
setwd('..') 
for (file in 2:length(sub_folders)){
  if (sub_folders[file] != "metadata") {
    setwd(sub_folders[file])
    shape_file = paste(sub_folders[file],".shp",sep="")
    thisCoC = readShapePoly(shape_file) 
    
    
    #finishes off Alaska
    all_cocs2=rbind(all_cocs2,thisCoC,makeUniqueIDs = TRUE)  
    setwd('..') 
  }
}
setwd('..') # move to parent directory, folder with full state name and all shapefile folders
setwd('..')


## did alaska manually, now continue
for (row in 2:length(all_state_folders)) {  #replace state$abbeviation with state name if necessary
  # for (row in 2:4) {   #smaller loop for testing code
  setwd(cocs_dir)
  current_state_folder = all_state_folders[row]
  setwd(paste(current_state_folder,orderedState[row,1],sep="/")) ## added to account for extra nested folder
  sub_folders = list.files()
  
  for (file in 1:length(sub_folders)){
    if (sub_folders[file] != "metadata") {
      setwd(sub_folders[file])
      shape_file = paste(sub_folders[file],".shp",sep="")
      thisCoC = readShapePoly(shape_file) 
      #thisCoC = thisCoC[,-(6:10)] #removes extraneous shapefile attributes
      
      #assigns homeless pop value to ARD col
      #for (i in 1:number_CoCs) {
      # CoC_num = chartr("-","_",byCoC$"CoC.Number"[i])  #makes CoC number in byCoC match number in folder name
      #if (CoC_num == sub_folders[file]) {
      # print(byCoC$"Total.Homeless..2015"[i])
      #thisCoC$ARD = byCoC$"Total.Homeless..2015"[i]
      #}
      #}
      
      #appends shapefile to all CoC shapefile
      all_cocs2 = rbind(all_cocs2,thisCoC,makeUniqueIDs = TRUE)  
      setwd('..')
    }
  }
  setwd('..') # move to parent directory, folder with full state name and all shapefile folders
  setwd('..') ## added to account for extra nested folder
}
#setwd('..') # move to parent directory, folder with all state folders
#}

#MUST CREATE LOOP FOR EACH YEAR

#Create new column for year
all_cocs2@data[["homeless2014"]] = all_cocs2@data$ARD

#assigns 2014 homeless pop value to new columns
all_cocs2@data$homeless2014=byCoC$"Total.Homeless..2015"[unlist(lapply(all_cocs2@data$COCNUM,function(x){which(byCoC$"CoC.Number"[1:number_CoCs]==x)}))]
class(all_cocs2)

library(maptools)
writeSpatialShape(all_cocs2, "allCOCs2014_2015homeless") ## save shapefile+data

# #assigns 2014 homeless pop value to new columns
# for (shp_row in 1:nrow(all_cocs2@data)){
#   for (xls_row in 1:number_CoCs) {
#     CoC_num = chartr("-","_",byCoC$"CoC.Number"[i])  #makes CoC number in byCoC match number in folder name
#     if (all_cocs2@data$COCNUM[shp_row] == byCoC$CoC.Number[xls_row]) {
#       print(byCoC$"Total.Homeless..2015"[xls_row])
#       all_cocs2@data$homeless2014[shp_row] = byCoC$"Total.Homeless..2015"[xls_row]
#     }
#   }
# }

#DELETE RAW FILES IF CODE COMPLETES

save.image("~/Desktop/drought_project/data/homeless/2014_coc_shapefile_data.RData")