#  DESCRIPTION: This code downloads the monthly NOAA weather station data for US climatological divisions, as well as NOAA's README file describing the data and methodology.  
#  Variables : precipitation, average temp, PDSI, PHDI, ZNDX, PMDI, Heating Degree Days, Cooling Degree Days.
#  For thorough discussion of these variables, see the noaa_official_README.txt. 
#  Created 3/28/2015 by Kate Pennington

library(plyr)
library(dplyr)

#  setwd("~/Drought")

facility_file <- read.csv("~/Desktop/NATIONAL_FACILITY_FILE.CSV")
sic_file <- read.csv("~/Desktop/NATIONAL_SIC_FILE.CSV")

# Define function to grab variables as table data frames
      as.tbl_df <- function(data) {
        dataset <- as.data.frame(data) %>%
          tbl_df()
      }

# Extract desired variables from facility csv
  id <- as.tbl_df(facility_file$REGISTRY_ID)
  fips <- as.tbl_df(as.character(facility_file$FIPS_CODE))
  lat <- as.tbl_df(facility_file$LATITUDE83)
  lon <- as.tbl_df(facility_file$LONGITUDE83)
    
    # Bind them into a tbl_df
    facility <- cbind(id, fips)
      names(facility) <- c("id", "fips")
      facility <- na.omit(facility)

# Extract desired variables from sic csv
  id <- as.tbl_df(sic_file$REGISTRY_ID)
  sic <- as.tbl_df(sic_file$SIC_CODE)
  
    sic <- cbind(id, sic)
      names(sic) <- c("id", "sic")
      sic <- na.omit(sic)
      sic$sic <- as.character(sic$sic)
# Merge
      
epa <- merge(facility, sic, by="id", all=FALSE)
  # Check the merge
      head(epa,10)
      tail(epa,100)
    nrow(epa) # 1439298 observations

  # Drop observations that are missing FIPS or SIC
      epa <- subset(epa, id!="REGISTRY_ID")
      epa <- subset(epa, fips!="")
    nrow(epa) # 1217115 observations
    
#  ADD dummy variable for water intensity of SIC code
    # Water-intensive industries:
    # 0100-0999 Agriculture, forestry, fishing
    # 2000-3999 Manufacturing
    # 4900-4932 Energy

  epa$sic <- as.numeric(epa$sic)
  epa$wUse <- 0
  epa$wUse <- ifelse((epa$sic <=999)|
                ((epa$sic >= 2000) & (epa$sic<= 3999)) |
                ((epa$sic>= 4900) & (epa$sic<= 4932)),
                1, 0)
                
 
