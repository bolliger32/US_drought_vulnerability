#  DESCRIPTION: This code downloads data from the EPA on regulated facilities.
#  We use this data to create a measure for the water-intensity of economic 
#  activity at the county level.  Caveats to the quality of this measure are 
#  described in the README.
#  The output of this code is a .csv with three variables: state FIPS, county FIPS,
#  and the number of water intensive facilities in the county.
#  Note: The original data file is very large; this code extracts just the variables
#  of interest and aggregates them to the county level.
#  Created 3/28/2015 by Kate Pennington

library(plyr)
library(dplyr)
library(micromapST)

# define file paths
args=commandArgs(trailingOnly=TRUE)
# test if there is at least one argument: if not, return an error
if (length(args)!=2) {
  dataDir <- file.path("..","..","data","epa")
  fOut <- file.path(dataDir,"clean_epa.csv")
  rawDir <- file.path(dataDir,"raw")
} else {
  fOut <- args[1]
  rawDir <- args[2]
}

facility_file <- read.csv(file.path(rawDir,"NATIONAL_FACILITY_FILE.CSV"))
sic_file <- read.csv(file.path(rawDir,"NATIONAL_SIC_FILE.CSV"))

# Define function to grab variables as table data frames
      as.tbl_df <- function(data) {
        dataset <- as.data.frame(data) %>%
          tbl_df()
      }

# Extract desired variables from facility csv
  id <- as.tbl_df(facility_file$REGISTRY_ID)
  fips <- as.tbl_df(as.character(facility_file$FIPS_CODE))

    # Bind them into a tbl_df
    facility <- cbind(id, fips)
      names(facility) <- c("id", "fips")
      facility <- na.omit(facility)

# Extract desired variables from sic csv
  id <- as.tbl_df(sic_file$REGISTRY_ID)
  sic <- as.tbl_df(sic_file$SIC_CODE)
  
    sic <- cbind(id, sic)
      names(sic) <- c("id", "sic")
      sic <- na.omit(sic)
      sic$sic <- as.character(sic$sic)

# Merge
epa <- merge(facility, sic, by="id", all=FALSE)
  # Check the merge
      head(epa,10)
      tail(epa,100)
    nrow(epa) # 1439298 observations

  # Drop observations that are missing FIPS or SIC
      epa <- subset(epa, id!="REGISTRY_ID")
      epa <- subset(epa, fips!="")
    nrow(epa) # 1217115 observations
    
#  ADD dummy variable for water intensity of SIC code
    # Water-intensive industries:
    # 0100-0999 Agriculture, forestry, fishing
    # 2000-3999 Manufacturing
    # 4900-4932 Energy

  epa$sic <- as.numeric(epa$sic)
  epa$wUse <- 0
  epa$wUse <- ifelse((epa$sic <=999)|
                ((epa$sic >= 2000) & (epa$sic<= 3999)) |
                ((epa$sic>= 4900) & (epa$sic<= 4932)),
                1, 0)
  # the FIPS codes are not consistent:
  # the state is identified first, but it is sometimes listed numerically
  # and sometimes by its abbreviation, ie, 01 vs. AK
  # First, we have to fix this:  
  
  epa <- subset(epa, nchar(as.character(epa$fips))==5)
  
  epa$COUNTYFP10 <- substr(epa$fips, start = 3, stop = 5)
  epa$STATEFP10 <- substr(epa$fips, start = 1, stop = 2)
  
  lookup <- stateNamesFips
      lookup$fips <- as.character(lookup$fips)
      lookup$fips[1:7] <- paste0("0",lookup$fips[1:7])
  
  # Identifies state fips codes that are not numeric    
    filter <- is.na(as.numeric(as.character(epa$STATEFP10)))
  # Replaces nonnumeric codes with numeric    
  epa$STATEFP10[filter] <- lookup$fips[match(epa$STATEFP10[filter],lookup$ab)]
  
  # check whether there are still nonnumeric codes
  filter2 <- is.na(as.numeric(as.character(epa$STATEFP10))) 
    sum(filter)
    sum(filter2) # yes there are! Grr.
    epa[which(filter2==TRUE),]  # Which states are giving us trouble?
  
  # Oh. NAs are Puerto Rico and Guam: We will drop them
  epa <- subset(epa,filter2==FALSE)
  
  # Now aggregate to the county level
 
  agby <- c("COUNTYFP10","STATEFP10")
  countyWuse <- ddply(epa,agby,summarize,wUse = sum(wUse))
  
  # Write out the new, clean .csv
  
  write.csv(countyWuse, file = fOut)
